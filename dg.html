<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#008751">

  <!-- iOS PWA Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="ARCON DG">

  <title>ARCON | DG Executive Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- HTML2PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            arconGreen: "#008751",
            arconGreenDark: "#00643C",
            arconGold: "#D4AF37",
            arconGoldLight: "#F4D03F",
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Merriweather', 'serif'],
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } }
          },
          backgroundImage: {
            'green-gradient': 'linear-gradient(135deg, #008751 0%, #005a32 100%)',
            'gold-gradient': 'linear-gradient(135deg, #D4AF37 0%, #B4941F 100%)',
          }
        }
      }
    }
  </script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Merriweather:wght@400;700;900&display=swap');

    body {
      font-family: Inter, sans-serif;
      background: #f8fafc;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior-y: none;
    }

    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
    .bottom-nav-safe { padding-bottom: max(env(safe-area-inset-bottom), 12px); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }

    /* ===========================
       REPORT SYSTEM (Executive PDF)
       =========================== */

    /* Hidden staging (A4 canvas target) */
    #report-staging-area {
      position: fixed;
      left: -99999px;
      top: 0;
      width: 794px;            /* A4 width @ 96dpi */
      min-height: 1123px;      /* A4 height @ 96dpi */
      background: #fff;
      z-index: -1;
      overflow: hidden;
    }

    /* Page wrapper */
    .report-page {
      width: 794px;
      min-height: 1123px;
      background: #fff;
      position: relative;
      overflow: hidden;
    }

    /* Watermark */
    .report-watermark {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.06;
      z-index: 0;
      background-image:
        repeating-linear-gradient( -30deg,
          rgba(0, 135, 81, 1) 0px,
          rgba(0, 135, 81, 1) 0px,
          transparent 1px,
          transparent 140px
        );
    }
    .report-watermark::after{
      content: "ARCON • IRMS • CONFIDENTIAL";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-20deg);
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 54px;
      letter-spacing: 0.18em;
      color: rgba(0, 0, 0, 1);
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* Fixed header/footer (repeated in multipage capture) */
    .report-header-fixed {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      height: 110px;
      background: #fff;
      z-index: 5;
      border-bottom: 1px solid #e5e7eb;
    }

    .report-footer-fixed {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 90px;
      background: #fff;
      z-index: 5;
      border-top: 1px solid #e5e7eb;
    }

    /* Content area leaves room for fixed header/footer */
    .report-body {
      position: relative;
      z-index: 2;
      padding: 140px 54px 120px 54px;
      font-family: Merriweather, serif;
      color: #111827;
    }

    .report-h1 {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 26px;
      letter-spacing: -0.02em;
      margin: 0 0 8px 0;
    }
    .report-h2 {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 14px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 22px 0 10px 0;
      color: #0f172a;
    }
    .report-h3 {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 13px;
      margin: 18px 0 8px 0;
      color: #0f172a;
    }
    .report-p {
      font-size: 12px;
      line-height: 1.75;
      margin: 0 0 12px 0;
      color: #111827;
      text-align: justify;
    }
    .report-small {
      font-size: 10px;
      color: #475569;
      line-height: 1.5;
    }

    .report-topband {
      height: 10px;
      background: linear-gradient(135deg, #008751 0%, #005a32 100%);
    }

    .report-headwrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 54px 14px 54px;
      gap: 16px;
    }

    .report-brand-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
    }

    .report-logo {
      width: 52px;
      height: 52px;
      border-radius: 12px;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .report-logo img { width: 100%; height: 100%; object-fit: cover; }

    .report-brand-titles {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .report-agency {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 14px;
      color: #0f172a;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      margin: 0;
      line-height: 1.1;
    }
    .report-system {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 10px;
      color: #008751;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      margin: 0;
      line-height: 1.1;
    }

    .report-meta {
      text-align: right;
      font-family: Inter, sans-serif;
      font-size: 10px;
      color: #475569;
      line-height: 1.45;
      min-width: 260px;
    }
    .report-meta strong {
      color: #0f172a;
      font-weight: 800;
    }

    .report-footer-wrap {
      padding: 14px 54px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      font-family: Inter, sans-serif;
      font-size: 10px;
      color: #64748b;
    }

    .report-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      font-weight: 800;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 9px;
      color: #0f172a;
      white-space: nowrap;
    }
    .report-chip b { color: #008751; }

    .report-kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 12px 0 8px 0;
    }
    .report-kpi {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 14px 14px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    .report-kpi .label {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 10px;
      color: #64748b;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .report-kpi .value {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 22px;
      letter-spacing: -0.02em;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .report-kpi .hint {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 10px;
      color: #334155;
    }
    .kpi-green { border-color: rgba(0,135,81,0.25); background: rgba(0,135,81,0.04); }
    .kpi-gold  { border-color: rgba(212,175,55,0.30); background: rgba(212,175,55,0.06); }
    .kpi-red   { border-color: rgba(220,38,38,0.25); background: rgba(220,38,38,0.04); }

    .report-callout {
      border-left: 4px solid #008751;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-left-width: 4px;
      border-radius: 14px;
      padding: 14px 14px;
      margin: 12px 0 14px 0;
    }
    .report-callout .t {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      color: #0f172a;
      margin-bottom: 6px;
    }
    .report-callout .b {
      font-family: Merriweather, serif;
      font-size: 12px;
      color: #0f172a;
      line-height: 1.7;
    }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin: 10px 0 14px 0;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
    }
    .report-table th {
      background: #0b3b25;
      color: #fff;
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 10px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .report-table td {
      padding: 9px 10px;
      border-bottom: 1px solid #eef2f7;
      color: #0f172a;
    }
    .report-table tr:nth-child(even) td {
      background: #f8fafc;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 9px;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .badge-success { background: #dcfce7; border-color: #86efac; color: #166534; }
    .badge-warning { background: #fef9c3; border-color: #fde047; color: #854d0e; }
    .badge-danger  { background: #fee2e2; border-color: #fca5a5; color: #991b1b; }
    .badge-neutral { background: #e2e8f0; border-color: #cbd5e1; color: #0f172a; }

    .report-barwrap {
      display: grid;
      grid-template-columns: 1.2fr 2fr;
      gap: 14px;
      align-items: start;
      margin: 8px 0 12px 0;
    }
    .report-barchart {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }
    .bar-row {
      display: grid;
      grid-template-columns: 90px 1fr 70px;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
      font-family: Inter, sans-serif;
    }
    .bar-row .nm {
      font-weight: 900;
      font-size: 10px;
      color: #0f172a;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .bar-row .rail {
      height: 10px;
      background: #e2e8f0;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #cbd5e1;
    }
    .bar-row .fill {
      height: 100%;
      background: linear-gradient(135deg, #008751 0%, #005a32 100%);
      border-radius: 999px;
    }
    .bar-row .val {
      text-align: right;
      font-weight: 900;
      font-size: 10px;
      color: #0f172a;
    }

    .report-signature {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
    }
    .sig-box {
      width: 280px;
      text-align: center;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      background: #fff;
    }
    .sig-name {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 12px;
      color: #0f172a;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      margin-top: 6px;
    }
    .sig-title {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 10px;
      color: #64748b;
      letter-spacing: 0.10em;
      text-transform: uppercase;
      margin-top: 2px;
    }
    .sig-line {
      height: 1px;
      background: #0f172a;
      margin: 6px 0 0 0;
      opacity: 0.55;
    }
    .sig-note {
      font-family: Inter, sans-serif;
      font-weight: 800;
      font-size: 9px;
      color: #64748b;
      margin-top: 6px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .cover {
      padding: 170px 54px 120px 54px;
      position: relative;
      z-index: 2;
    }
    .cover-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(0,135,81,0.08);
      border: 1px solid rgba(0,135,81,0.22);
      font-family: Inter, sans-serif;
      font-weight: 900;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 10px;
      color: #0f172a;
    }
    .cover-title {
      font-family: Inter, sans-serif;
      font-weight: 950;
      font-size: 40px;
      letter-spacing: -0.03em;
      margin: 18px 0 10px 0;
      color: #0f172a;
      line-height: 1.05;
    }
    .cover-sub {
      font-family: Merriweather, serif;
      font-size: 14px;
      color: #334155;
      line-height: 1.7;
      max-width: 560px;
      margin: 0 0 16px 0;
    }
    .cover-meta {
      margin-top: 18px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      max-width: 560px;
    }
    .cover-meta .item {
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 12px 12px;
      background: #fff;
    }
    .cover-meta .k {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #64748b;
      margin-bottom: 6px;
    }
    .cover-meta .v {
      font-family: Inter, sans-serif;
      font-weight: 900;
      font-size: 14px;
      color: #0f172a;
    }
    .cover-footer-note {
      position: absolute;
      left: 54px;
      right: 54px;
      bottom: 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-family: Inter, sans-serif;
      font-size: 10px;
      color: #64748b;
      z-index: 2;
    }

    .page-break { page-break-before: always; break-before: page; }

    /* Improve html2canvas capture consistency */
    #report-staging-area, .report-page, .report-header-fixed, .report-footer-fixed {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  </style>
</head>

<body class="flex h-screen overflow-hidden text-gray-800 bg-slate-50 pb-[calc(70px+env(safe-area-inset-bottom))] md:pb-0">

  <!-- APP CONTAINER -->
  <div id="app-container" class="flex h-full w-full">

    <!-- DESKTOP SIDEBAR -->
    <aside class="hidden md:flex w-72 bg-green-gradient text-white border-r border-white/10 flex-col flex-shrink-0 z-20 relative shadow-xl">
      <div class="h-24 flex items-center px-6 border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center shadow-lg transform rotate-3 transition hover:rotate-0 overflow-hidden">
            <img src="https://raw.githubusercontent.com/KingAmada/arcon/refs/heads/main/arcon.jpg" class="w-12 h-12 object-cover" alt="ARCON Logo">
          </div>
          <div>
            <h1 class="font-extrabold text-white text-xl tracking-tight leading-none">ARCON</h1>
            <div class="text-[10px] font-bold text-green-100/80 uppercase tracking-[0.15em] mt-1">Executive Suite</div>
          </div>
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
        <div class="px-3 py-2">
          <p class="text-[10px] font-black uppercase tracking-widest text-green-200/60 mb-3">High Command</p>
          <button onclick="setView('overview')" class="desktop-nav-btn group w-full text-left px-4 py-4 rounded-xl flex items-center gap-3 text-sm font-semibold transition-all duration-200 text-white/80 hover:bg-white/10 hover:text-white hover:shadow-lg">
            <i class="ph ph-chart-line-up text-xl"></i> Overview
          </button>
          <button onclick="setView('agencies')" class="desktop-nav-btn group w-full text-left px-4 py-4 rounded-xl flex items-center gap-3 text-sm font-semibold transition-all duration-200 text-white/80 hover:bg-white/10 hover:text-white hover:shadow-lg">
            <i class="ph ph-buildings text-xl"></i> Agency Registry
          </button>
          <button onclick="setView('map')" class="desktop-nav-btn group w-full text-left px-4 py-4 rounded-xl flex items-center gap-3 text-sm font-semibold transition-all duration-200 text-white/80 hover:bg-white/10 hover:text-white hover:shadow-lg">
            <i class="ph ph-globe-hemisphere-west text-xl"></i> National Map
          </button>
        </div>

        <div class="px-3 py-2 mt-4">
          <p class="text-[10px] font-black uppercase tracking-widest text-green-200/60 mb-3">Intelligence</p>
          <button onclick="setView('reports')" class="desktop-nav-btn group w-full text-left px-4 py-4 rounded-xl flex items-center gap-3 text-sm font-semibold transition-all duration-200 text-white/80 hover:bg-white/10 hover:text-white hover:shadow-lg">
            <i class="ph ph-file-pdf text-xl"></i> Reports Center
          </button>
        </div>
      </nav>

      <div class="p-4 border-t border-white/10">
        <div class="bg-black/20 rounded-2xl p-4 text-white backdrop-blur-sm border border-white/5">
          <div class="flex items-center justify-between mb-3">
            <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center font-bold border border-white/10">
              <i class="ph ph-crown text-2xl text-arconGold"></i>
            </div>
            <div class="h-2 w-2 rounded-full bg-green-400 animate-pulse shadow-[0_0_8px_rgba(74,222,128,0.5)]"></div>
          </div>
          <div>
            <div class="text-xs text-white/60 font-medium uppercase tracking-wide">Welcome,</div>
            <div class="font-bold text-base">Director General</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-gray-200 flex items-center justify-around z-40 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] bottom-nav-safe h-[calc(70px+env(safe-area-inset-bottom))]">
      <button onclick="setView('overview')" id="mob-nav-overview" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 active text-arconGreen transition-colors group">
        <div class="p-1.5 rounded-xl group-hover:bg-gray-50 transition-colors">
          <i class="ph ph-chart-line-up text-2xl mb-0.5"></i>
        </div>
        <span class="text-[10px] font-bold">Stats</span>
      </button>
      <button onclick="setView('agencies')" id="mob-nav-agencies" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors group">
        <div class="p-1.5 rounded-xl group-hover:bg-gray-50 transition-colors">
          <i class="ph ph-buildings text-2xl mb-0.5"></i>
        </div>
        <span class="text-[10px] font-bold">Agencies</span>
      </button>
      <button onclick="setView('reports')" id="mob-nav-reports" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors group">
        <div class="p-1.5 rounded-xl group-hover:bg-gray-50 transition-colors">
          <i class="ph ph-file-pdf text-2xl mb-0.5"></i>
        </div>
        <span class="text-[10px] font-bold">Reports</span>
      </button>
      <button onclick="setView('map')" id="mob-nav-map" class="mobile-nav-btn flex flex-col items-center justify-center w-full h-full text-gray-400 transition-colors group">
        <div class="p-1.5 rounded-xl group-hover:bg-gray-50 transition-colors">
          <i class="ph ph-globe-hemisphere-west text-2xl mb-0.5"></i>
        </div>
        <span class="text-[10px] font-bold">Map</span>
      </button>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 bg-slate-50/50 pt-safe">

      <!-- Header -->
      <header class="h-16 md:h-24 bg-white/80 backdrop-blur-md border-b border-gray-200/60 flex items-center justify-between px-4 md:px-8 sticky top-0 md:relative z-10">
        <div>
          <h2 class="font-black text-gray-800 text-xl md:text-2xl flex items-center gap-3 tracking-tight">
            <span class="md:hidden text-arconGreen">
              <img src="https://raw.githubusercontent.com/KingAmada/arcon/refs/heads/main/arcon.jpg" class="w-8 h-8 object-contain" alt="ARCON Logo">
            </span>
            <span id="page-title">Executive Dashboard</span>
          </h2>
          <p class="hidden md:block text-sm text-gray-500 font-medium mt-1">Real-time regulatory oversight & revenue metrics</p>
        </div>
        <div class="flex items-center gap-3">
          <span class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 text-arconGreen text-xs font-bold rounded-full border border-green-100">
            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Live
          </span>
          <button onclick="location.reload()" class="w-10 h-10 flex items-center justify-center text-gray-400 hover:text-arconGreen hover:bg-green-50 transition-all rounded-full active:scale-95 bg-white border border-gray-100 shadow-sm">
            <i class="ph ph-arrows-clockwise text-xl"></i>
          </button>
        </div>
      </header>

      <!-- Content Scroll Area -->
      <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">

        <!-- VIEW: OVERVIEW -->
        <div id="view-overview" class="space-y-6 animate-fade-in pb-8">
          <!-- Filters -->
          <div class="bg-white p-4 rounded-2xl border border-gray-100 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between sticky top-0 z-20 md:relative">
            <div class="flex items-center gap-2 w-full md:w-auto text-gray-500 text-sm font-bold">
              <i class="ph ph-funnel text-arconGreen"></i> Drill Down:
            </div>
            <div class="flex gap-2 w-full md:w-auto overflow-x-auto">
              <select id="filter-state" onchange="populateLgas()" class="bg-slate-50 border border-gray-200 text-sm rounded-xl px-4 py-2.5 outline-none font-medium min-w-[140px] focus:ring-2 focus:ring-arconGreen/20">
                <option value="all">All States</option>
              </select>
              <select id="filter-lga" class="bg-slate-50 border border-gray-200 text-sm rounded-xl px-4 py-2.5 outline-none font-medium min-w-[140px] focus:ring-2 focus:ring-arconGreen/20">
                <option value="all">All LGAs</option>
              </select>
              <button onclick="applyFilters()" class="bg-arconGreen text-white px-4 py-2.5 rounded-xl font-bold shadow-lg shadow-arconGreen/20 hover:bg-arconGreenDark transition active:scale-95">
                Update View
              </button>
            </div>
          </div>

          <!-- Expanded Metrics Grid -->
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm card-hover group">
              <div class="flex justify-between items-start mb-3">
                <div class="w-10 h-10 rounded-xl bg-green-50 text-arconGreen flex items-center justify-center text-xl"><i class="ph ph-currency-ngn"></i></div>
                <span class="text-green-600 text-[10px] font-bold bg-green-50 px-2 py-1 rounded-full">+12%</span>
              </div>
              <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Revenue</p>
              <h3 id="stat-revenue" class="text-2xl font-black text-gray-800 mt-0.5">₦45.2M</h3>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm card-hover group">
              <div class="flex justify-between items-start mb-3">
                <div class="w-10 h-10 rounded-xl bg-yellow-50 text-arconGold flex items-center justify-center text-xl"><i class="ph ph-shield-check"></i></div>
              </div>
              <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Compliance</p>
              <h3 id="stat-compliance" class="text-2xl font-black text-gray-800 mt-0.5">68%</h3>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm card-hover group">
              <div class="flex justify-between items-start mb-3">
                <div class="w-10 h-10 rounded-xl bg-blue-50 text-blue-600 flex items-center justify-center text-xl"><i class="ph ph-buildings"></i></div>
              </div>
              <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Agencies</p>
              <h3 id="stat-agencies" class="text-2xl font-black text-gray-800 mt-0.5">1,240</h3>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm card-hover group">
              <div class="flex justify-between items-start mb-3">
                <div class="w-10 h-10 rounded-xl bg-red-50 text-red-600 flex items-center justify-center text-xl"><i class="ph ph-gavel"></i></div>
              </div>
              <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Enforcements</p>
              <h3 id="stat-enforcements" class="text-2xl font-black text-gray-800 mt-0.5">85</h3>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Chart -->
            <div class="lg:col-span-2 bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
              <div class="flex justify-between items-center mb-6">
                <div>
                  <h4 class="font-bold text-gray-800 text-lg">Revenue Trend</h4>
                  <p class="text-xs text-gray-400">Monthly breakdown (Millions NGN)</p>
                </div>
                <button class="text-arconGreen hover:bg-green-50 p-2 rounded-lg transition" onclick="generatePDF('financial')">
                  <i class="ph ph-download-simple text-xl"></i>
                </button>
              </div>
              <div class="h-64 w-full">
                <canvas id="revChart"></canvas>
              </div>
            </div>

            <!-- Live Intelligence Feed -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col">
              <div class="mb-4 flex items-center justify-between">
                <div>
                  <h4 class="font-bold text-gray-800 text-lg">Regulatory Alerts</h4>
                  <p class="text-xs text-gray-400">Real-time situational awareness</p>
                </div>
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
              </div>
              <div class="flex-1 overflow-y-auto space-y-4 pr-2 max-h-[250px] custom-scrollbar">
                <div class="flex gap-3 items-start border-l-2 border-red-500 pl-3">
                  <div>
                    <p class="text-xs font-bold text-gray-800">Unlicensed Billboard detected</p>
                    <p class="text-[10px] text-gray-500">Ikeja, Lagos • 12 mins ago</p>
                  </div>
                </div>
                <div class="flex gap-3 items-start border-l-2 border-yellow-500 pl-3">
                  <div>
                    <p class="text-xs font-bold text-gray-800">Compliance Rate Drop</p>
                    <p class="text-[10px] text-gray-500">Rivers State • 2 hours ago</p>
                  </div>
                </div>
                <div class="flex gap-3 items-start border-l-2 border-green-500 pl-3">
                  <div>
                    <p class="text-xs font-bold text-gray-800">New Agency Registration</p>
                    <p class="text-[10px] text-gray-500">Abuja FCT • 4 hours ago</p>
                  </div>
                </div>
                <div class="flex gap-3 items-start border-l-2 border-gray-300 pl-3">
                  <div>
                    <p class="text-xs font-bold text-gray-800">System Backup Complete</p>
                    <p class="text-[10px] text-gray-500">System • 6 hours ago</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- VIEW: AGENCIES -->
        <div id="view-agencies" class="hidden space-y-6 animate-fade-in pb-8">
          <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
              <h2 class="text-xl font-bold text-gray-800">Agency Registry</h2>
              <p class="text-sm text-gray-500">Monitor advertising practitioners and their portfolios.</p>
            </div>
            <div class="w-full md:w-auto relative">
              <i class="ph ph-magnifying-glass absolute left-3 top-3 text-gray-400"></i>
              <input type="text" id="agency-search" oninput="renderAgencies()" placeholder="Search Agency Name or RC..." class="pl-10 pr-4 py-2.5 border border-gray-200 rounded-xl text-sm w-full md:w-64 focus:ring-2 focus:ring-arconGreen/20 outline-none">
            </div>
          </div>

          <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-400 font-bold text-[11px] uppercase tracking-wider border-b border-gray-100">
                  <tr>
                    <th class="px-6 py-4">Agency Details</th>
                    <th class="px-6 py-4">RC Number</th>
                    <th class="px-6 py-4 text-center">Active Ads</th>
                    <th class="px-6 py-4 text-center">Compliance Score</th>
                    <th class="px-6 py-4 text-right">Action</th>
                  </tr>
                </thead>
                <tbody id="agencies-table-body" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: REPORTS -->
        <div id="view-reports" class="hidden space-y-6 animate-fade-in pb-8">
          <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-20 md:relative">
            <div>
              <h2 class="text-xl font-bold text-gray-800">Reports Center</h2>
              <p class="text-sm text-gray-500">Generate and export official executive-grade documents.</p>
            </div>
            <div class="flex gap-1 bg-gray-50 p-1.5 rounded-xl border border-gray-100">
              <button onclick="setReportPeriod(this, 'Daily')" class="report-period-btn active px-4 py-2 bg-white text-arconGreen font-bold rounded-lg shadow-sm text-xs transition-all">Daily</button>
              <button onclick="setReportPeriod(this, 'Monthly')" class="report-period-btn px-4 py-2 text-gray-500 hover:text-gray-700 font-bold rounded-lg text-xs transition-all">Monthly</button>
              <button onclick="setReportPeriod(this, 'Yearly')" class="report-period-btn px-4 py-2 text-gray-500 hover:text-gray-700 font-bold rounded-lg text-xs transition-all">Yearly</button>
            </div>
          </div>

          <!-- Report Types Grid (ALL SAMPLES) -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <!-- Executive Summary -->
            <div class="bg-green-gradient text-white p-6 rounded-3xl shadow-lg relative overflow-hidden group cursor-pointer hover:shadow-xl transition-all hover:scale-[1.02] border border-white/10"
                 onclick="generatePDF('executive')">
              <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-bl-[100px] -mr-6 -mt-6 transition-transform group-hover:scale-110"></div>
              <div class="relative z-10">
                <div class="w-12 h-12 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center text-2xl mb-4 border border-white/20">
                  <i class="ph ph-presentation-chart"></i>
                </div>
                <h3 class="text-lg font-bold">Executive Summary</h3>
                <p class="text-xs text-green-100 mt-1 mb-6 opacity-90">Cover page + KPIs + recommendations + performance matrix + signature page.</p>
                <button class="w-full py-3 bg-white text-arconGreen rounded-xl text-xs font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">
                  <i class="ph ph-download-simple text-lg"></i> Download PDF
                </button>
              </div>
            </div>

            <!-- Financial -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group cursor-pointer hover:border-arconGreen hover:shadow-md transition-all"
                 onclick="generatePDF('financial')">
              <div class="w-12 h-12 bg-green-50 text-arconGreen rounded-xl flex items-center justify-center text-2xl mb-4"><i class="ph ph-currency-ngn"></i></div>
              <h3 class="text-lg font-bold text-gray-800">Financial Report</h3>
              <p class="text-xs text-gray-400 mt-1 mb-6">Revenue streams, zonal contributions, transaction summary, and projections.</p>
              <button class="w-full py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-bold text-gray-600 flex items-center justify-center gap-2 transition-colors">
                <i class="ph ph-download-simple text-lg"></i> Download PDF
              </button>
            </div>

            <!-- Enforcement -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group cursor-pointer hover:border-red-500 hover:shadow-md transition-all"
                 onclick="generatePDF('enforcement')">
              <div class="w-12 h-12 bg-red-50 text-red-600 rounded-xl flex items-center justify-center text-2xl mb-4"><i class="ph ph-warning-octagon"></i></div>
              <h3 class="text-lg font-bold text-gray-800">Enforcement Log</h3>
              <p class="text-xs text-gray-400 mt-1 mb-6">Violations, investigations, sanctions, status, and compliance summary.</p>
              <button class="w-full py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-bold text-gray-600 flex items-center justify-center gap-2 transition-colors">
                <i class="ph ph-download-simple text-lg"></i> Download PDF
              </button>
            </div>

            <!-- Agency Registry Summary -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group cursor-pointer hover:border-blue-500 hover:shadow-md transition-all"
                 onclick="generatePDF('agency')">
              <div class="w-12 h-12 bg-blue-50 text-blue-700 rounded-xl flex items-center justify-center text-2xl mb-4"><i class="ph ph-buildings"></i></div>
              <h3 class="text-lg font-bold text-gray-800">Agency Registry Summary</h3>
              <p class="text-xs text-gray-400 mt-1 mb-6">Top agencies, compliance ranking, and notable campaigns overview.</p>
              <button class="w-full py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-bold text-gray-600 flex items-center justify-center gap-2 transition-colors">
                <i class="ph ph-download-simple text-lg"></i> Download PDF
              </button>
            </div>

            <!-- Zonal Performance -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group cursor-pointer hover:border-arconGreen hover:shadow-md transition-all"
                 onclick="generatePDF('zonal')">
              <div class="w-12 h-12 bg-emerald-50 text-emerald-700 rounded-xl flex items-center justify-center text-2xl mb-4"><i class="ph ph-map-trifold"></i></div>
              <h3 class="text-lg font-bold text-gray-800">Zonal Performance</h3>
              <p class="text-xs text-gray-400 mt-1 mb-6">Zone-by-zone collections, compliance delta, and intervention priorities.</p>
              <button class="w-full py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-bold text-gray-600 flex items-center justify-center gap-2 transition-colors">
                <i class="ph ph-download-simple text-lg"></i> Download PDF
              </button>
            </div>

            <!-- Compliance Brief -->
            <div class="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm relative overflow-hidden group cursor-pointer hover:border-yellow-500 hover:shadow-md transition-all"
                 onclick="generatePDF('compliance')">
              <div class="w-12 h-12 bg-yellow-50 text-yellow-700 rounded-xl flex items-center justify-center text-2xl mb-4"><i class="ph ph-shield-check"></i></div>
              <h3 class="text-lg font-bold text-gray-800">Compliance Brief</h3>
              <p class="text-xs text-gray-400 mt-1 mb-6">Compliance rate, categories of breaches, and corrective actions plan.</p>
              <button class="w-full py-3 bg-gray-50 hover:bg-gray-100 rounded-xl text-xs font-bold text-gray-600 flex items-center justify-center gap-2 transition-colors">
                <i class="ph ph-download-simple text-lg"></i> Download PDF
              </button>
            </div>

          </div>

          <!-- Recent Reports Table -->
          <div class="bg-white rounded-3xl border border-gray-100 shadow-sm overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
              <h3 class="font-bold text-gray-800 text-sm md:text-base">Recent Activity</h3>
              <span class="text-xs text-gray-400 font-medium">Auto-archived for 90 days</span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-400 font-bold text-[11px] uppercase tracking-wider">
                  <tr>
                    <th class="px-6 py-4">Report Name</th>
                    <th class="px-6 py-4">Date Generated</th>
                    <th class="px-6 py-4">Type</th>
                    <th class="px-6 py-4 text-right">Action</th>
                  </tr>
                </thead>
                <tbody id="report-history-body" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- VIEW: MAP -->
        <div id="view-map" class="hidden h-[75vh] md:h-full flex flex-col bg-white rounded-3xl border border-gray-200 shadow-sm overflow-hidden relative animate-fade-in">
          <div class="absolute top-4 left-4 right-4 z-[400] flex justify-between items-start pointer-events-none">
            <div class="bg-white/95 backdrop-blur rounded-2xl shadow-xl border border-gray-100 p-4 pointer-events-auto">
              <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2"><i class="ph ph-globe text-arconGreen"></i> National Compliance Map</h3>
              <p class="text-[10px] text-gray-400 mt-1">Live feed from zonal offices</p>
            </div>
            <div class="bg-white/95 backdrop-blur rounded-full px-4 py-2 shadow-xl border border-gray-100 text-xs font-bold flex gap-4 pointer-events-auto">
              <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-arconGreen shadow-sm shadow-green-500/50"></span> Compliant</span>
              <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-sm shadow-red-500/50"></span> Illegal/Expired</span>
            </div>
          </div>
          <div id="map-dg" class="flex-grow w-full bg-slate-100 z-0"></div>
        </div>

      </div>
    </main>

    <!-- LOADING TOAST -->
    <div id="toast-loading" class="fixed bottom-24 right-6 bg-gray-900 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3 hidden animate-slide-up">
      <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
      <div>
        <p class="font-bold text-sm">Generating PDF...</p>
        <p class="text-xs text-gray-400">Compiling layout, branding, and pagination.</p>
      </div>
    </div>

    <!-- REPORT STAGING AREA (Hidden) -->
    <div id="report-staging-area"></div>

    <!-- AGENCY DETAIL MODAL -->
    <div id="agency-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden animate-slide-up max-h-[85vh] flex flex-col">
        <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
          <div>
            <h3 class="font-bold text-xl text-gray-900" id="modal-agency-name">--</h3>
            <p class="text-xs text-gray-500 font-mono" id="modal-agency-rc">RC: --</p>
          </div>
          <button onclick="document.getElementById('agency-modal').classList.add('hidden')" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center hover:bg-gray-300"><i class="ph ph-x"></i></button>
        </div>
        <div class="p-6 overflow-y-auto">
          <div class="flex gap-4 mb-6">
            <div class="flex-1 bg-green-50 p-4 rounded-2xl border border-green-100">
              <p class="text-xs font-bold text-green-700 uppercase">Running Ads</p>
              <h4 class="text-2xl font-black text-green-900" id="modal-agency-ads">0</h4>
            </div>
            <div class="flex-1 bg-blue-50 p-4 rounded-2xl border border-blue-100">
              <p class="text-xs font-bold text-blue-700 uppercase">APCON ID</p>
              <h4 class="text-lg font-bold text-blue-900" id="modal-agency-id">--</h4>
            </div>
          </div>
          <h4 class="font-bold text-gray-800 mb-3 text-sm border-b pb-2">Active Campaigns</h4>
          <ul class="space-y-3" id="modal-campaign-list"></ul>
        </div>
      </div>
    </div>

  </div>

  <script>
    /* ===========================
       DATA (Sample / Demo)
       =========================== */
    const BRAND = {
      agencyName: "Advertising Regulatory Council of Nigeria",
      shortName: "ARCON",
      systemName: "Integrated Regulatory Management System (IRMS)",
      address: "Plot 12, Augustus Aikhomu Way, Utako District, Abuja",
      website: "www.arcon.gov.ng",
      logoUrl: "https://raw.githubusercontent.com/KingAmada/arcon/refs/heads/main/arcon.jpg"
    };

    const NIGERIA_DATA = [
      { state: "Abuja FCT", lgas: ["Abaji", "Abuja Municipal", "Bwari", "Gwagwalada", "Kuje", "Kwali"] },
      { state: "Lagos", lgas: ["Agege", "Ajeromi-Ifelodun", "Alimosho", "Amuwo-Odofin", "Apapa", "Badagry", "Epe", "Eti Osa", "Ibeju-Lekki", "Ifako-Ijaiye", "Ikeja", "Ikorodu", "Kosofe", "Lagos Island", "Lagos Mainland", "Mushin", "Ojo", "Oshodi-Isolo", "Shomolu", "Surulere"] },
      { state: "Rivers", lgas: ["Abua/Odual", "Ahoada East", "Ahoada West", "Akuku-Toru", "Andoni", "Asari-Toru", "Bonny", "Degema", "Eleme", "Emohua", "Etche", "Gokana", "Ikwerre", "Khana", "Obio/Akpor", "Ogba/Egbema/Ndoni", "Ogu/Bolo", "Okrika", "Omuma", "Opobo/Nkoro", "Oyigbo", "Port Harcourt", "Tai"] },
      { state: "Kano", lgas: ["Ajingi", "Albasu", "Bagwai", "Bebeji", "Bichi", "Bunkure", "Dala", "Dambatta", "Dawakin Kudu", "Dawakin Tofa", "Doguwa", "Fagge", "Gabasawa", "Garko", "Garun Mallam", "Gaya", "Gezawa", "Gwale", "Gwarzo", "Kabo", "Kano Municipal", "Karaye", "Kibiya", "Kiru", "Kumbotso", "Kunchi", "Kura", "Madobi", "Makoda", "Minjibir", "Nasarawa", "Rano", "Rimin Gado", "Rogo", "Shanono", "Sumaila", "Takai", "Tarauni", "Tofa", "Tsanyawa", "Tudun Wada", "Ungogo", "Warawa", "Wudil"] },
      { state: "Enugu", lgas: ["Aninri", "Awgu", "Enugu East", "Enugu North", "Enugu South", "Ezeagu", "Igbo Etiti", "Igbo Eze North", "Igbo Eze South", "Isi Uzo", "Nkanu East", "Nkanu West", "Nsukka", "Oji River", "Udenu", "Udi", "Uzo Uwani"] },
      { state: "Oyo", lgas: ["Afijio", "Akinyele", "Atiba", "Atisbo", "Egbeda", "Ibadan North", "Ibadan North-East", "Ibadan North-West", "Ibadan South-East", "Ibadan South-West", "Ibarapa Central", "Ibarapa East", "Ibarapa North", "Ido", "Irepo", "Iseyin", "Itesiwaju", "Iwajowa", "Kajola", "Lagelu", "Ogbomosho North", "Ogbomosho South", "Ogo Oluwa", "Olorunsogo", "Oluyole", "Ona Ara", "Orelope", "Ori Ire", "Oyo East", "Oyo West", "Saki East", "Saki West", "Surulere"] },
    ];

    const AGENCIES = [
      { name: "Insight Publicis", rc: "RC123456", id: "APCON/001", ads: 45, score: 98, campaigns: ["Glo Unlimited", "Pepsi Naija", "Heineken UEFA"] },
      { name: "X3M Ideas", rc: "RC987654", id: "APCON/042", ads: 32, score: 95, campaigns: ["DSTV Premium", "Access Bank Marathon"] },
      { name: "Noah's Ark", rc: "RC456789", id: "APCON/015", ads: 28, score: 92, campaigns: ["Airtel 4G", "Indomie Noodles"] },
      { name: "DDB Lagos", rc: "RC112233", id: "APCON/008", ads: 40, score: 96, campaigns: ["MTN 5G", "Fidelity Bank"] },
      { name: "Yellow Brick Road", rc: "RC554433", id: "APCON/102", ads: 12, score: 88, campaigns: ["First Bank Centenary"] },
      { name: "MediaReach OMD", rc: "RC778899", id: "APCON/055", ads: 55, score: 99, campaigns: ["Guinness Gold", "Nestle Milo", "Omo Detergent"] },
      { name: "7even Interactive", rc: "RC998877", id: "APCON/110", ads: 18, score: 89, campaigns: ["Fidelity Bank", "Uber Nigeria"] },
      { name: "So&U", rc: "RC445566", id: "APCON/020", ads: 38, score: 94, campaigns: ["Globacom", "Guinness"] }
    ];

    let mapInstance = null;
    let revChart = null;
    let currentReportPeriod = 'Daily';

    // Cached logo as DataURL for perfect PDF rendering
    let _logoDataUrl = null;

    // Report history now stores enough info to regenerate the exact report on click
    const REPORT_HISTORY = [
      { key: "executive", name: "Executive Summary - Q3", date: "2025-10-01", type: "Executive Summary", period: "Monthly" },
      { key: "financial", name: "Financial Audit Oct", date: "2025-10-05", type: "Financial Report", period: "Monthly" }
    ];

    /* ===========================
       UTILITIES
       =========================== */
    function pad2(n){ return String(n).padStart(2, "0"); }

    function isoToday(){
      const d = new Date();
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    function fmtDateLong(d = new Date()){
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function fmtNGN(n){
      try {
        return new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', maximumFractionDigits: 0 }).format(n);
      } catch {
        return `₦${Math.round(n).toLocaleString()}`;
      }
    }

    function randomRef(){
      return `ARCON-${Math.floor(100000 + Math.random()*900000)}`;
    }

    function safeText(str){
      return String(str).replace(/[<>&"]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[s]));
    }

    async function ensureLogoDataUrl(){
      if(_logoDataUrl) return _logoDataUrl;
      try{
        const res = await fetch(BRAND.logoUrl, { mode: "cors", cache: "force-cache" });
        const blob = await res.blob();
        _logoDataUrl = await new Promise((resolve) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result);
          r.readAsDataURL(blob);
        });
        return _logoDataUrl;
      } catch(e){
        console.warn("Logo fetch failed, using URL fallback:", e);
        _logoDataUrl = BRAND.logoUrl;
        return _logoDataUrl;
      }
    }

    function toast(on){
      const t = document.getElementById('toast-loading');
      if(on) t.classList.remove('hidden');
      else t.classList.add('hidden');
    }

    /* ===========================
       CORE INIT
       =========================== */
    function init() {
      populateStates();
      setView('overview');
      initCharts();
      renderAgencies();
      renderReportHistory();
    }

    function setView(viewId) {
      ['overview', 'agencies', 'reports', 'map'].forEach(v => document.getElementById('view-'+v).classList.add('hidden'));
      document.getElementById('view-'+viewId).classList.remove('hidden');

      document.querySelectorAll('.desktop-nav-btn, .mobile-nav-btn').forEach(el => {
        el.classList.remove('text-arconGreen', 'bg-white', 'shadow-lg');
        if(el.classList.contains('desktop-nav-btn')) el.classList.add('text-white/80', 'hover:bg-white/10');
        else el.classList.add('text-gray-400');
      });

      const dBtn = document.querySelector(`.desktop-nav-btn[onclick*="${viewId}"]`);
      if(dBtn) {
        dBtn.classList.remove('text-white/80', 'hover:bg-white/10');
        dBtn.classList.add('bg-white', 'text-arconGreen', 'shadow-lg');
      }

      const mBtn = document.getElementById('mob-nav-'+viewId);
      if(mBtn) {
        mBtn.classList.remove('text-gray-400');
        mBtn.classList.add('text-arconGreen');
      }

      document.getElementById('page-title').innerText = viewId.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      if(viewId === 'map') setTimeout(initMap, 200);
    }

    /* ===========================
       FILTERS
       =========================== */
    function populateStates() {
      const sel = document.getElementById('filter-state');
      NIGERIA_DATA.sort((a,b) => a.state.localeCompare(b.state)).forEach(s => {
        let opt = document.createElement('option');
        opt.value = s.state; opt.innerText = s.state;
        sel.appendChild(opt);
      });
    }

    function populateLgas() {
      const stateVal = document.getElementById('filter-state').value;
      const lgaSel = document.getElementById('filter-lga');
      lgaSel.innerHTML = '<option value="all">All LGAs</option>';

      const stateData = NIGERIA_DATA.find(s => s.state === stateVal);
      if(stateData) {
        stateData.lgas.slice().sort().forEach(l => {
          let opt = document.createElement('option');
          opt.value = l; opt.innerText = l;
          lgaSel.appendChild(opt);
        });
      }
    }

    function applyFilters() {
      const state = document.getElementById('filter-state').value;
      const lga = document.getElementById('filter-lga').value;

      const factor = state === 'all' ? 1 : 0.4;

      document.getElementById('stat-revenue').innerText = '₦' + (45.2 * factor * (0.9 + Math.random()*0.2)).toFixed(1) + 'M';
      document.getElementById('stat-compliance').innerText = Math.floor(68 * (0.8 + Math.random()*0.4)) + '%';
      document.getElementById('stat-agencies').innerText = Math.floor(1240 * factor);
      document.getElementById('stat-enforcements').innerText = Math.floor(85 * factor);

      if(revChart) {
        revChart.data.datasets[0].data = revChart.data.datasets[0].data.map(v => v * factor * (0.8 + Math.random()*0.4));
        revChart.update();
      }

      const locText = state === 'all' ? 'National View' : `${state}${lga !== 'all' ? ', ' + lga : ''}`;
      alert(`Dashboard updated for: ${locText}`);
    }

    /* ===========================
       AGENCIES MODULE
       =========================== */
    function renderAgencies() {
      const search = document.getElementById('agency-search')?.value?.toLowerCase?.() || "";
      const tbody = document.getElementById('agencies-table-body');
      tbody.innerHTML = '';

      AGENCIES
        .filter(a => a.name.toLowerCase().includes(search) || a.rc.toLowerCase().includes(search))
        .forEach(agency => {
          const row = `
            <tr class="hover:bg-slate-50 border-b border-gray-50 transition cursor-pointer" onclick="showAgencyModal('${safeText(agency.name)}')">
              <td class="px-6 py-4 font-bold text-gray-800">${safeText(agency.name)}</td>
              <td class="px-6 py-4 font-mono text-gray-500 text-xs">${safeText(agency.rc)}</td>
              <td class="px-6 py-4 text-center"><span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-lg text-xs font-bold">${agency.ads} Active</span></td>
              <td class="px-6 py-4 text-center">
                <div class="w-full bg-gray-100 rounded-full h-2 w-24 mx-auto">
                  <div class="bg-green-500 h-2 rounded-full" style="width: ${agency.score}%"></div>
                </div>
                <span class="text-[10px] text-gray-400 font-bold mt-1 block">${agency.score}%</span>
              </td>
              <td class="px-6 py-4 text-right">
                <button class="text-gray-400 hover:text-arconGreen"><i class="ph ph-caret-right text-lg"></i></button>
              </td>
            </tr>
          `;
          tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    function showAgencyModal(name) {
      const agency = AGENCIES.find(a => a.name === name);
      if(!agency) return;

      document.getElementById('modal-agency-name').innerText = agency.name;
      document.getElementById('modal-agency-rc').innerText = `RC: ${agency.rc}`;
      document.getElementById('modal-agency-id').innerText = agency.id;
      document.getElementById('modal-agency-ads').innerText = agency.ads;

      const list = document.getElementById('modal-campaign-list');
      list.innerHTML = agency.campaigns.map(c => `
        <li class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-gray-100">
          <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm text-arconGreen"><i class="ph ph-megaphone-simple"></i></div>
          <div><p class="text-sm font-bold text-gray-800">${safeText(c)}</p><p class="text-[10px] text-green-600 font-bold">● Running</p></div>
        </li>
      `).join('');

      document.getElementById('agency-modal').classList.remove('hidden');
    }

    /* ===========================
       REPORTS MODULE
       =========================== */
    function setReportPeriod(btn, period) {
      document.querySelectorAll('.report-period-btn').forEach(b => {
        b.classList.remove('bg-white', 'text-arconGreen', 'shadow-sm');
        b.classList.add('text-gray-500');
      });
      btn.classList.add('bg-white', 'text-arconGreen', 'shadow-sm');
      btn.classList.remove('text-gray-500');
      currentReportPeriod = period;
    }

    function reportTypeLabel(key){
      return ({
        executive: "Executive Summary",
        financial: "Financial Report",
        enforcement: "Enforcement Log",
        agency: "Agency Registry Summary",
        zonal: "Zonal Performance",
        compliance: "Compliance Brief"
      }[key] || "Executive Report");
    }

    function renderReportHistory() {
      const tbody = document.getElementById('report-history-body');
      tbody.innerHTML = '';
      REPORT_HISTORY.forEach((r, idx) => {
        const row = `
          <tr class="hover:bg-slate-50 transition">
            <td class="px-6 py-4 font-bold text-gray-800 flex items-center gap-2">
              <i class="ph ph-file-pdf text-red-500 text-lg"></i> ${safeText(r.name)}
            </td>
            <td class="px-6 py-4 text-gray-500 text-xs">${safeText(r.date)}</td>
            <td class="px-6 py-4">
              <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">${safeText(r.type)}</span>
              <span class="ml-2 bg-green-50 text-arconGreen px-2 py-1 rounded text-xs font-bold">${safeText(r.period)}</span>
            </td>
            <td class="px-6 py-4 text-right">
              <button class="text-arconGreen font-bold text-xs hover:underline"
                      onclick="downloadFromHistory(event, ${idx})">
                Download
              </button>
            </td>
          </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }

    function downloadFromHistory(ev, idx){
      ev?.stopPropagation?.();
      const item = REPORT_HISTORY[idx];
      if(!item) return;
      // regenerate (always downloads a beautiful executive pdf)
      generatePDF(item.key, { period: item.period, forceName: item.name, forceDate: item.date });
    }

    function buildReportHeader(meta){
      return `
        <div class="report-topband"></div>
        <div class="report-header-fixed">
          <div class="report-headwrap">
            <div class="report-brand-left">
              <div class="report-logo">
                <img src="${meta.logo}" alt="ARCON Logo">
              </div>
              <div class="report-brand-titles">
                <p class="report-agency">Federal Republic of Nigeria</p>
                <p class="report-system">${safeText(BRAND.shortName)} • ${safeText(BRAND.systemName)}</p>
              </div>
            </div>

            <div class="report-meta">
              <div><strong>Report:</strong> ${safeText(meta.reportType)}</div>
              <div><strong>Period:</strong> ${safeText(meta.period)}</div>
              <div><strong>Date:</strong> ${safeText(meta.dateLong)}</div>
              <div><strong>Ref:</strong> ${safeText(meta.ref)}</div>
            </div>
          </div>
        </div>
      `;
    }

    function buildReportFooter(meta){
      return `
        <div class="report-footer-fixed">
          <div class="report-footer-wrap">
            <div class="report-small">
              <div><b>${safeText(BRAND.shortName)}</b> • ${safeText(BRAND.address)} • ${safeText(BRAND.website)}</div>
              <div class="report-small">This document is confidential and intended for authorized executive use only.</div>
            </div>
            <div class="report-chip"><b>DG</b> Terminal • IRMS • <span id="pdfPageCounter">Pagination</span></div>
          </div>
        </div>
      `;
    }

    function buildCoverPage(meta){
      return `
        <div class="report-page">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="cover">
            <div class="cover-badge">
              <span style="width:10px;height:10px;border-radius:999px;background:#008751;display:inline-block;"></span>
              EXECUTIVE REPORT • ${safeText(meta.reportType.toUpperCase())}
            </div>

            <div class="cover-title">${safeText(meta.coverTitle)}</div>
            <div class="cover-sub">
              Official executive brief generated via the <b>${safeText(BRAND.systemName)}</b>.
              This report consolidates revenue, compliance, enforcement, and registry intelligence for strategic action.
            </div>

            <div class="cover-meta">
              <div class="item"><div class="k">Reporting Period</div><div class="v">${safeText(meta.period)}</div></div>
              <div class="item"><div class="k">Reference No.</div><div class="v">${safeText(meta.ref)}</div></div>
              <div class="item"><div class="k">Prepared For</div><div class="v">Director General</div></div>
              <div class="item"><div class="k">Generated</div><div class="v">${safeText(meta.dateLong)}</div></div>
            </div>

            <div class="cover-footer-note">
              <div>Classification: <b>CONFIDENTIAL</b></div>
              <div>System: <b>${safeText(BRAND.shortName)} IRMS</b> • Document Hash: <b>${safeText(meta.hash)}</b></div>
            </div>
          </div>
        </div>
      `;
    }

    function buildSignatureBlock(meta){
      return `
        <div class="report-signature">
          <div class="sig-box">
            <div style="font-family: cursive; font-size: 26px; color: #008751; line-height: 1; margin-bottom: 6px;">
              Dr. Olalekan Fadolapo
            </div>
            <div class="sig-line"></div>
            <div class="sig-name">Dr. Olalekan Fadolapo</div>
            <div class="sig-title">Director General</div>
            <div class="sig-note">Digitally Signed & Authenticated</div>
          </div>
        </div>
      `;
    }

    function buildExecutiveBody(meta){
      return `
        <div class="report-page">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Executive Summary</div>
            <div class="report-small">
              This executive summary provides a consolidated view of core KPIs and priority actions for the reporting period.
            </div>

            <div class="report-kpi-grid">
              <div class="report-kpi kpi-green">
                <div class="label">Total Revenue</div>
                <div class="value">₦45.2M</div>
                <div class="hint">▲ +12% vs benchmark</div>
              </div>
              <div class="report-kpi kpi-gold">
                <div class="label">Compliance Rate</div>
                <div class="value">68%</div>
                <div class="hint">Focus states: Rivers, Delta</div>
              </div>
              <div class="report-kpi kpi-red">
                <div class="label">Active Enforcements</div>
                <div class="value">85</div>
                <div class="hint">Top class: illegal siting</div>
              </div>
            </div>

            <div class="report-callout">
              <div class="t">Executive Insight</div>
              <div class="b">
                Revenue performance remains strong, with the Lagos zone contributing the highest collections via digital vetting and licensing.
                However, compliance deterioration in select South-South corridors indicates urgent need for coordinated zonal enforcement
                and streamlined reporting from partner signage agencies.
              </div>
            </div>

            <div class="report-h2">Strategic Recommendations</div>
            <div class="report-p">
              1) Deploy a targeted enforcement sprint to Port Harcourt and Asaba with weekly outcome reporting.
              2) Integrate state signage billing and permit verification (LASAA/KASUPDA equivalents) into IRMS for unified collections.
              3) Refresh vetting fee structure for emerging digital ad formats while strengthening creative pre-screening workflows.
            </div>

            <div class="report-h2">Performance Matrix</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>KPI Category</th>
                  <th>Target</th>
                  <th>Actual</th>
                  <th>Variance</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>License Revenue</td>
                  <td>₦40.0M</td>
                  <td>₦45.2M</td>
                  <td>+13%</td>
                  <td><span class="badge badge-success">Exceeded</span></td>
                </tr>
                <tr>
                  <td>Agency Registration</td>
                  <td>1,200</td>
                  <td>1,240</td>
                  <td>+3.3%</td>
                  <td><span class="badge badge-success">On Track</span></td>
                </tr>
                <tr>
                  <td>Ad Vetting Volume</td>
                  <td>500</td>
                  <td>485</td>
                  <td>-3%</td>
                  <td><span class="badge badge-warning">Near Target</span></td>
                </tr>
                <tr>
                  <td>Litigation Cases</td>
                  <td>&lt; 5</td>
                  <td>2</td>
                  <td>-60%</td>
                  <td><span class="badge badge-success">Optimal</span></td>
                </tr>
              </tbody>
            </table>

            <div class="report-h2">Priority Actions</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Owner</th>
                  <th>Due</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>South-South compliance intervention (PHC/Asaba)</td>
                  <td>Zonal Director</td>
                  <td>14 days</td>
                  <td><span class="badge badge-warning">In Progress</span></td>
                </tr>
                <tr>
                  <td>Unified billing integration with state signage agencies</td>
                  <td>IRMS Program Office</td>
                  <td>30 days</td>
                  <td><span class="badge badge-warning">Planned</span></td>
                </tr>
                <tr>
                  <td>Digital media vetting pipeline enhancement</td>
                  <td>Compliance Unit</td>
                  <td>21 days</td>
                  <td><span class="badge badge-neutral">Queued</span></td>
                </tr>
              </tbody>
            </table>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildFinancialBody(meta){
      const total = 45200000;
      return `
        <div class="report-page page-break">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Financial Report</div>
            <div class="report-small">Detailed breakdown of all revenue streams processed through IRMS for the reporting period.</div>

            <div class="report-h2">Revenue Streams</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Revenue Stream</th>
                  <th style="text-align:center;">Tx Count</th>
                  <th style="text-align:right;">Gross (NGN)</th>
                  <th style="text-align:right;">Net (NGN)</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Vetting Fees (Digital)</td><td style="text-align:center;">320</td><td style="text-align:right;">${fmtNGN(18500000)}</td><td style="text-align:right;">${fmtNGN(18500000)}</td></tr>
                <tr><td>Vetting Fees (Traditional)</td><td style="text-align:center;">130</td><td style="text-align:right;">${fmtNGN(6500000)}</td><td style="text-align:right;">${fmtNGN(6500000)}</td></tr>
                <tr><td>Practitioner Licenses</td><td style="text-align:center;">120</td><td style="text-align:right;">${fmtNGN(12000000)}</td><td style="text-align:right;">${fmtNGN(12000000)}</td></tr>
                <tr><td>Fines & Penalties</td><td style="text-align:center;">45</td><td style="text-align:right;">${fmtNGN(5200000)}</td><td style="text-align:right;">${fmtNGN(5200000)}</td></tr>
                <tr><td>Corporate Registration</td><td style="text-align:center;">30</td><td style="text-align:right;">${fmtNGN(3000000)}</td><td style="text-align:right;">${fmtNGN(3000000)}</td></tr>
                <tr style="font-weight: 900;">
                  <td>TOTAL REVENUE</td><td style="text-align:center;">645</td><td style="text-align:right;">${fmtNGN(total)}</td><td style="text-align:right;">${fmtNGN(total)}</td>
                </tr>
              </tbody>
            </table>

            <div class="report-h2">Zonal Contribution</div>
            <div class="report-barwrap">
              <div class="report-barchart">
                <div class="report-h3" style="margin-top:0;">Collections by Zone</div>
                <div class="bar-row">
                  <div class="nm">Lagos</div>
                  <div class="rail"><div class="fill" style="width:63%"></div></div>
                  <div class="val">63%</div>
                </div>
                <div class="bar-row">
                  <div class="nm">Abuja</div>
                  <div class="rail"><div class="fill" style="width:22%; opacity:0.85;"></div></div>
                  <div class="val">22%</div>
                </div>
                <div class="bar-row">
                  <div class="nm">Kano</div>
                  <div class="rail"><div class="fill" style="width:9%; opacity:0.65;"></div></div>
                  <div class="val">9%</div>
                </div>
                <div class="bar-row">
                  <div class="nm">PHC</div>
                  <div class="rail"><div class="fill" style="width:6%; opacity:0.55;"></div></div>
                  <div class="val">6%</div>
                </div>
              </div>

              <div>
                <div class="report-callout" style="margin-top:0;">
                  <div class="t">Financial Interpretation</div>
                  <div class="b">
                    Lagos remains the primary revenue driver via digital vetting throughput. Abuja is stable, while Kano and PHC show mild contraction,
                    which correlates with reduced campaign volume and increased compliance friction.
                  </div>
                </div>

                <table class="report-table">
                  <thead>
                    <tr>
                      <th>Region</th>
                      <th>Revenue</th>
                      <th>Growth (MoM)</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td>Lagos Zone</td><td>${fmtNGN(28500000)}</td><td><span class="badge badge-success">+5.2%</span></td></tr>
                    <tr><td>Abuja HQ</td><td>${fmtNGN(10200000)}</td><td><span class="badge badge-success">+1.8%</span></td></tr>
                    <tr><td>Kano Zone</td><td>${fmtNGN(4100000)}</td><td><span class="badge badge-warning">-0.5%</span></td></tr>
                    <tr><td>Port Harcourt</td><td>${fmtNGN(2400000)}</td><td><span class="badge badge-danger">-2.1%</span></td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="report-h2">Forward Projection (Sample)</div>
            <div class="report-p">
              Projection assumes improved compliance-driven conversion of pending vetting and a 6–10% lift in digital media volume.
              With unified billing integration, collections are expected to increase by an estimated ₦3.5M–₦6.0M in the next cycle.
            </div>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildEnforcementBody(meta){
      return `
        <div class="report-page page-break">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Enforcement Log</div>
            <div class="report-small">Record of regulatory breaches, investigative actions, notices, removals, and sanctions.</div>

            <div class="report-h2">Incident Register</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Entity / Agency</th>
                  <th>Violation Type</th>
                  <th>Location</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>2025-10-12</td><td>Globus Marketing</td><td>Illegal Siting (No Permit)</td><td>Ikeja, Lagos</td><td><span class="badge badge-danger">Sanctioned</span></td></tr>
                <tr><td>2025-10-11</td><td>Prime Media Ltd</td><td>Unapproved Creative</td><td>Wuse II, Abuja</td><td><span class="badge badge-warning">Under Review</span></td></tr>
                <tr><td>2025-10-09</td><td>City Wall Ads</td><td>Expired License</td><td>GRA, Port Harcourt</td><td><span class="badge badge-warning">Removal Notice</span></td></tr>
                <tr><td>2025-10-08</td><td>NextGen Promo</td><td>Indecent Exposure</td><td>Kano Municipal</td><td><span class="badge badge-danger">Litigation</span></td></tr>
                <tr><td>2025-10-05</td><td>Alpha Outdoor</td><td>Non-payment of Fees</td><td>Lekki, Lagos</td><td><span class="badge badge-danger">Sealed</span></td></tr>
                <tr><td>2025-10-02</td><td>Zenith Boards</td><td>Structural Defect</td><td>Enugu North</td><td><span class="badge badge-success">Resolved</span></td></tr>
              </tbody>
            </table>

            <div class="report-h2">Compliance Summary</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Metric</th>
                  <th>Count</th>
                  <th>Interpretation</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Total Violations Reported</td><td>142</td><td>Driven by illegal siting and expired licenses</td></tr>
                <tr><td>Compliance Notices Served</td><td>98</td><td>Notice-to-removal conversion target: 60%</td></tr>
                <tr><td>Direct Enforcement (Removals)</td><td>22</td><td>Requires cross-agency support in hotspots</td></tr>
                <tr><td>Pending Legal Actions</td><td>4</td><td>High priority: public decency + structural risk</td></tr>
              </tbody>
            </table>

            <div class="report-callout">
              <div class="t">Immediate Action</div>
              <div class="b">
                Increase field verification frequency for high-traffic corridors and enforce expiry auto-flagging through IRMS
                to reduce manual gaps. Recommend joint operations with state signage agencies for faster removals and higher fine recovery.
              </div>
            </div>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildAgencyBody(meta){
      const top = AGENCIES.slice().sort((a,b)=>b.score-a.score).slice(0,5);
      return `
        <div class="report-page page-break">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Agency Registry Summary</div>
            <div class="report-small">Snapshot of registry performance, top compliance agencies, and high-activity campaigns.</div>

            <div class="report-h2">Top Compliance Agencies</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Agency</th>
                  <th>RC</th>
                  <th>APCON ID</th>
                  <th style="text-align:center;">Active Ads</th>
                  <th style="text-align:center;">Compliance</th>
                </tr>
              </thead>
              <tbody>
                ${top.map(a => `
                  <tr>
                    <td>${safeText(a.name)}</td>
                    <td>${safeText(a.rc)}</td>
                    <td>${safeText(a.id)}</td>
                    <td style="text-align:center;">${a.ads}</td>
                    <td style="text-align:center;"><span class="badge badge-success">${a.score}%</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="report-h2">Notable Campaign Activity</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Agency</th>
                  <th>Campaigns (Sample)</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${AGENCIES.slice(0,6).map(a => `
                  <tr>
                    <td>${safeText(a.name)}</td>
                    <td>${safeText(a.campaigns.join(", "))}</td>
                    <td><span class="badge badge-success">Running</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div class="report-callout">
              <div class="t">Registry Insight</div>
              <div class="b">
                High-performing agencies show consistent creative pre-clearance and timely renewal behavior.
                Recommend incentivizing early renewals via IRMS alerts and enforcing automatic ad suspension for expiry violations.
              </div>
            </div>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildZonalBody(meta){
      return `
        <div class="report-page page-break">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Zonal Performance</div>
            <div class="report-small">Zone-by-zone revenue and compliance signal, highlighting hotspots and intervention priorities.</div>

            <div class="report-h2">Zone Scorecard</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Zone</th>
                  <th>Revenue</th>
                  <th>Compliance</th>
                  <th>Enforcement Cases</th>
                  <th>Priority</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Lagos</td><td>${fmtNGN(28500000)}</td><td><span class="badge badge-success">74%</span></td><td>31</td><td><span class="badge badge-warning">Medium</span></td></tr>
                <tr><td>Abuja</td><td>${fmtNGN(10200000)}</td><td><span class="badge badge-success">71%</span></td><td>18</td><td><span class="badge badge-neutral">Low</span></td></tr>
                <tr><td>Kano</td><td>${fmtNGN(4100000)}</td><td><span class="badge badge-warning">62%</span></td><td>16</td><td><span class="badge badge-warning">Medium</span></td></tr>
                <tr><td>Port Harcourt</td><td>${fmtNGN(2400000)}</td><td><span class="badge badge-danger">58%</span></td><td>20</td><td><span class="badge badge-danger">High</span></td></tr>
              </tbody>
            </table>

            <div class="report-h2">Intervention Plan (Sample)</div>
            <div class="report-p">
              PHC corridor requires a 2-week compliance sweep focusing on expired licensing, illegal siting, and fee recovery.
              Kano requires creative pre-screening tightening, while Lagos requires sustained throughput protection and dispute resolution.
            </div>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildComplianceBody(meta){
      return `
        <div class="report-page page-break">
          <div class="report-watermark"></div>
          ${buildReportHeader(meta)}
          ${buildReportFooter(meta)}

          <div class="report-body">
            <div class="report-h1">Compliance Brief</div>
            <div class="report-small">Compliance rate summary, breach categories, corrective actions, and risk notes.</div>

            <div class="report-h2">Compliance Snapshot</div>
            <div class="report-kpi-grid">
              <div class="report-kpi kpi-gold">
                <div class="label">Overall Compliance</div>
                <div class="value">68%</div>
                <div class="hint">Goal: ≥ 75%</div>
              </div>
              <div class="report-kpi kpi-red">
                <div class="label">High-Risk Breaches</div>
                <div class="value">22</div>
                <div class="hint">Structural + public decency</div>
              </div>
              <div class="report-kpi kpi-green">
                <div class="label">Resolved Cases</div>
                <div class="value">57</div>
                <div class="hint">Improving closures</div>
              </div>
            </div>

            <div class="report-h2">Top Breach Categories</div>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Count</th>
                  <th>Trend</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>Illegal Siting</td><td>54</td><td><span class="badge badge-danger">Rising</span></td><td>Joint operations + permit verification</td></tr>
                <tr><td>Expired License</td><td>39</td><td><span class="badge badge-warning">Stable</span></td><td>Auto-flag + suspension workflow</td></tr>
                <tr><td>Unapproved Creative</td><td>27</td><td><span class="badge badge-warning">Stable</span></td><td>Pre-clearance enforcement</td></tr>
                <tr><td>Non-payment</td><td>22</td><td><span class="badge badge-danger">Rising</span></td><td>Collections enforcement + sealing</td></tr>
              </tbody>
            </table>

            <div class="report-callout">
              <div class="t">Risk Note</div>
              <div class="b">
                If illegal siting remains unchecked, it erodes fee recovery, increases public safety exposure, and weakens deterrence.
                Recommend a “fast-track enforcement lane” with daily notice issuance and weekly removal targets.
              </div>
            </div>

            ${buildSignatureBlock(meta)}
          </div>
        </div>
      `;
    }

    function buildReportHTML(key, meta){
      // Cover + body pages (multi-page)
      const coverTitle = reportTypeLabel(key);
      const metaFull = {
        ...meta,
        coverTitle,
      };

      let body = "";
      if(key === "executive") body = buildExecutiveBody(metaFull);
      else if(key === "financial") body = buildFinancialBody(metaFull);
      else if(key === "enforcement") body = buildEnforcementBody(metaFull);
      else if(key === "agency") body = buildAgencyBody(metaFull);
      else if(key === "zonal") body = buildZonalBody(metaFull);
      else if(key === "compliance") body = buildComplianceBody(metaFull);
      else body = buildExecutiveBody(metaFull);

      return `
        <div>
          ${buildCoverPage(metaFull)}
          ${body}
        </div>
      `;
    }

    async function generatePDF(key, overrides = {}) {
      const staging = document.getElementById('report-staging-area');
      toast(true);

      const dateObj = overrides.forceDate ? new Date(overrides.forceDate + "T12:00:00") : new Date();
      const dateLong = fmtDateLong(dateObj);
      const ref = randomRef();
      const period = overrides.period || currentReportPeriod;
      const reportType = reportTypeLabel(key);

      const logo = await ensureLogoDataUrl();
      const hash = Math.floor(100000000 + Math.random()*900000000).toString(16).toUpperCase();

      const meta = { logo, dateLong, ref, period, reportType, hash };

      // Inject HTML (executive multi-page)
      staging.innerHTML = buildReportHTML(key, meta);

      // Filename
      const fileDate = overrides.forceDate || isoToday();
      const baseName = overrides.forceName
        ? overrides.forceName.replace(/[^\w\- ]+/g,'').trim().replace(/\s+/g,'_')
        : `${reportTypeLabel(key)}_${period}`.replace(/\s+/g,'_');
      const filename = `${BRAND.shortName}_${baseName}_${fileDate}.pdf`;

      // html2pdf options tuned for crisp executive look
      const opt = {
        margin: 0,
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: {
          scale: 2.5,
          useCORS: true,
          allowTaint: false,
          scrollY: 0,
          windowWidth: 794
        },
        jsPDF: { unit: 'px', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      try {
        // Add page numbers + save
        await html2pdf()
          .set(opt)
          .from(staging)
          .toPdf()
          .get('pdf')
          .then((pdf) => {
            const pageCount = pdf.internal.getNumberOfPages();
            for(let i=1; i<=pageCount; i++){
              pdf.setPage(i);
              pdf.setFontSize(9);
              pdf.setTextColor(120);
              const w = pdf.internal.pageSize.getWidth();
              const h = pdf.internal.pageSize.getHeight();
              pdf.text(`Page ${i} of ${pageCount}`, w - 70, h - 18);
              pdf.text(`${BRAND.shortName} • IRMS`, 54, h - 18);
            }
          })
          .save();

        // Add to history (top)
        const item = {
          key,
          name: `${reportTypeLabel(key)} - ${period}`,
          date: fileDate,
          type: reportTypeLabel(key),
          period
        };
        REPORT_HISTORY.unshift(item);
        renderReportHistory();
      } catch (err) {
        console.error(err);
        alert("Error generating PDF. Please try again.");
      } finally {
        toast(false);
      }
    }

    /* ===========================
       MAP + CHARTS
       =========================== */
    function initMap() {
      if(mapInstance) { mapInstance.invalidateSize(); return; }
      mapInstance = L.map('map-dg').setView([9.0820, 8.6753], 6);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM' }).addTo(mapInstance);

      const style = { fillColor: '#008751', fillOpacity: 0.65, radius: 7, weight: 2, color: 'white' };
      L.circleMarker([9.07, 7.39], style).addTo(mapInstance).bindTooltip("Abuja HQ • Compliant");
      L.circleMarker([6.52, 3.37], style).addTo(mapInstance).bindTooltip("Lagos • High Activity");
    }

    function initCharts() {
      const canvas = document.getElementById('revChart');
      if(!canvas) return;
      const ctx = canvas.getContext('2d');

      const grad = ctx.createLinearGradient(0,0,0,300);
      grad.addColorStop(0, 'rgba(0, 135, 81, 0.18)');
      grad.addColorStop(1, 'rgba(0, 135, 81, 0)');

      revChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Jan','Feb','Mar','Apr','May','Jun'],
          datasets: [{
            label: 'Revenue',
            data: [15, 22, 18, 30, 28, 45.2],
            borderColor: '#008751',
            backgroundColor: grad,
            fill: true,
            tension: 0.4,
            pointRadius: 3,
            pointHoverRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } }
        }
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
