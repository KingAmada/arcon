<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0" />
  <title>IRMS — DG Portal</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap');
    html, body { font-family: Outfit, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .no-print{display:block;}
    @media print{ .no-print{display:none!important;} body{background:#fff!important;} }
  </style>

  <script>
    tailwind.config = { theme: { extend: { colors: { "ng-green":"#0ea75a", "ng-green-dark":"#0b7f45" } } } }
  </script>
</head>

<body class="bg-gray-50 text-gray-900">
  <header class="no-print sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-gray-900 text-white grid place-items-center font-black">IR</div>
        <div>
          <div class="font-black tracking-tight">IRMS</div>
          <div class="text-xs text-gray-500 -mt-0.5">DG Portal</div>
        </div>
      </div>

      <span class="px-3 py-1 rounded-full text-xs font-black border border-gray-200 bg-white">Portal: DG</span>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <aside class="no-print lg:col-span-3">
      <div class="bg-white border border-gray-200 rounded-2xl shadow-sm overflow-hidden">
        <div class="p-4 border-b border-gray-200">
          <div class="font-black text-lg">Navigation</div>
          <div class="text-xs text-gray-500">DG access only</div>
        </div>

        <nav class="p-2 space-y-1">
          <a id="nav-dashboard" href="#" onclick="switchTab('dashboard')" class="nav-item block px-4 py-3 rounded-xl font-bold text-sm hover:bg-gray-50">Overview Dashboard</a>
          <a id="nav-revenue" href="#" onclick="switchTab('revenue')" class="nav-item block px-4 py-3 rounded-xl font-bold text-sm hover:bg-gray-50">Revenue & Projections</a>
          <a id="nav-verification" href="#" onclick="switchTab('verification')" class="nav-item block px-4 py-3 rounded-xl font-bold text-sm hover:bg-gray-50">Verification Portal</a>
        </nav>

        <div class="p-4 border-t border-gray-200">
          <div class="text-xs text-gray-500">
            Payment account:
            <div class="font-black text-gray-900 mt-1">ARCON ADs VETTING</div>
            <div>Stanbic IBTC Bank</div>
            <div class="font-mono font-black">5770242424</div>
          </div>
        </div>
      </div>
    </aside>

    <section class="lg:col-span-9 space-y-6">
      <!-- DASHBOARD -->
      <section id="dashboard-view" class="view-section hidden space-y-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
          <div class="flex flex-wrap items-end justify-between gap-4">
            <div>
              <h1 class="text-2xl font-black">DG Overview Dashboard</h1>
              <p class="text-sm text-gray-500 mt-1">Real-time licensing pipeline, payment clearance, and verified certificates.</p>
            </div>
            <div class="text-right">
              <div class="text-xs text-gray-500">System Snapshot</div>
              <div id="snapshot-date" class="font-black"></div>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Applications</div>
              <div id="stat-apps" class="text-3xl font-black mt-1">0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Awaiting Payment</div>
              <div id="stat-awaiting" class="text-3xl font-black mt-1">0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Under Review</div>
              <div id="stat-underreview" class="text-3xl font-black mt-1">0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Approved</div>
              <div id="stat-approved" class="text-3xl font-black mt-1">0</div>
            </div>
          </div>

          <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="border border-gray-200 rounded-2xl p-4">
              <div class="flex items-center justify-between">
                <div class="font-black">Revenue Trend (Cleared)</div>
                <div class="text-xs text-gray-500">Updates from staff payment confirmations</div>
              </div>
              <canvas id="revenueChart" class="mt-3"></canvas>
            </div>

            <div class="border border-gray-200 rounded-2xl p-4">
              <div class="font-black">Top States (Approved)</div>
              <div class="text-xs text-gray-500">Where certificates are being issued.</div>
              <div id="top-states" class="mt-4 space-y-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- REVENUE -->
      <section id="revenue-view" class="view-section hidden space-y-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
          <h2 class="text-2xl font-black">Revenue & Projections</h2>
          <p class="text-sm text-gray-500 mt-1">High-level numbers for leadership (cleared vs pending).</p>

          <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Cleared Revenue</div>
              <div id="rev-cleared" class="text-2xl font-black mt-1">₦0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Pending (Awaiting/Under Review)</div>
              <div id="rev-pending" class="text-2xl font-black mt-1">₦0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Avg Fee / Application</div>
              <div id="rev-avg" class="text-2xl font-black mt-1">₦0</div>
            </div>
            <div class="p-4 rounded-2xl border border-gray-200 bg-gray-50">
              <div class="text-xs text-gray-500 font-bold">Projected Monthly (Run-rate)</div>
              <div id="rev-proj" class="text-2xl font-black mt-1">₦0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- VERIFICATION -->
      <section id="verification-view" class="view-section hidden space-y-6">
        <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6">
          <h2 class="text-2xl font-black">Verification Portal</h2>
          <p class="text-sm text-gray-500 mt-1">Verify a certificate number (or QR content).</p>

          <div class="mt-5 grid grid-cols-1 md:grid-cols-3 gap-3">
            <input id="verify-input" class="p-3 border border-gray-300 rounded-xl outline-none focus:ring-2 focus:ring-ng-green" placeholder="Enter Certificate No or QR text">
            <button onclick="verifyCertificate()" class="bg-gray-900 text-white rounded-xl font-black hover:bg-black">Verify</button>
            <button onclick="fillFromUrlCert()" class="border border-gray-300 rounded-xl font-black hover:bg-gray-50">Use URL Cert</button>
          </div>

          <div id="verify-result" class="mt-5 hidden border border-gray-200 rounded-2xl p-5 bg-gray-50"></div>
        </div>
      </section>
    </section>
  </main>

  <script>
    // ===== SHARED CORE (DG) =====
    const PORTAL="dg";
    const STORAGE_KEYS = { APPS:"IRMS_APPS_V1", REV:"IRMS_REV_V1" };
    const APP_STATUS = {
      AWAITING_PAYMENT:"AWAITING_PAYMENT",
      PAYMENT_UNDER_REVIEW:"PAYMENT_UNDER_REVIEW",
      UNDER_REVIEW:"UNDER_REVIEW",
      QUERIED:"QUERIED",
      APPROVED:"APPROVED",
      REJECTED:"REJECTED"
    };

    let APPLICATIONS_DATA=[];
    let REVENUE_DATA=[];
    let __revChart=null;

    function formatNGN(n){
      const v=Number(n||0);
      return new Intl.NumberFormat('en-NG',{style:'currency',currency:'NGN',maximumFractionDigits:0}).format(v);
    }
    function escapeHtml(s){ return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

    function loadData(){
      const apps=localStorage.getItem(STORAGE_KEYS.APPS);
      const rev=localStorage.getItem(STORAGE_KEYS.REV);
      APPLICATIONS_DATA = apps ? JSON.parse(apps) : [];
      REVENUE_DATA = rev ? JSON.parse(rev) : [];
    }

    const VIEWS=["dashboard","revenue","verification"];
    function switchTab(key){
      VIEWS.forEach(v=>document.getElementById(`${v}-view`)?.classList.toggle("hidden", v!==key));
      document.querySelectorAll(".nav-item").forEach(a=>a.classList.remove("bg-gray-900","text-white"));
      const map={dashboard:"nav-dashboard", revenue:"nav-revenue", verification:"nav-verification"};
      document.getElementById(map[key])?.classList.add("bg-gray-900","text-white");

      if(key==="dashboard") { updateDashboardStats(); drawDGChart(); }
      if(key==="revenue") renderRevenue();
    }

    function updateDashboardStats(){
      const apps=APPLICATIONS_DATA.length;
      const awaiting=APPLICATIONS_DATA.filter(a=>a.status===APP_STATUS.AWAITING_PAYMENT || a.status===APP_STATUS.PAYMENT_UNDER_REVIEW).length;
      const under=APPLICATIONS_DATA.filter(a=>a.status===APP_STATUS.UNDER_REVIEW).length;
      const approved=APPLICATIONS_DATA.filter(a=>a.status===APP_STATUS.APPROVED).length;

      document.getElementById("stat-apps").textContent=apps;
      document.getElementById("stat-awaiting").textContent=awaiting;
      document.getElementById("stat-underreview").textContent=under;
      document.getElementById("stat-approved").textContent=approved;

      const approvedApps=APPLICATIONS_DATA.filter(a=>a.status===APP_STATUS.APPROVED);
      const counts=approvedApps.reduce((acc,a)=>{ acc[a.state]=(acc[a.state]||0)+1; return acc; },{});
      const top=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,6);
      const wrap=document.getElementById("top-states");
      wrap.innerHTML = top.map(([s,c])=>`
        <div class="flex items-center justify-between border border-gray-200 rounded-xl p-3 bg-gray-50">
          <div class="font-black">${escapeHtml(s)}</div>
          <div class="px-2 py-1 rounded-full border border-gray-200 bg-white font-black text-xs">${c}</div>
        </div>
      `).join("") || `<div class="text-sm text-gray-500">No approved data yet.</div>`;
    }

    function drawDGChart(){
      const canvas=document.getElementById("revenueChart");
      if(!canvas) return;

      const byDate={};
      REVENUE_DATA.forEach(r=>{
        if(r.status!=="CLEARED") return;
        byDate[r.date]=(byDate[r.date]||0)+(r.amount||0);
      });

      const dates=Object.keys(byDate).sort().slice(-7);
      const vals=dates.map(d=>byDate[d]);

      if(__revChart) __revChart.destroy();
      __revChart=new Chart(canvas,{
        type:"bar",
        data:{ labels: dates.length ? dates : ["No data"], datasets:[{ label:"Cleared Revenue", data: vals.length ? vals : [0] }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ ticks:{ callback:(v)=>"₦"+Number(v).toLocaleString() } } }
        }
      });
    }

    function renderRevenue(){
      const cleared = REVENUE_DATA.filter(r=>r.status==="CLEARED").reduce((s,r)=>s+(r.amount||0),0);
      const pending = APPLICATIONS_DATA
        .filter(a => a.status===APP_STATUS.AWAITING_PAYMENT || a.status===APP_STATUS.PAYMENT_UNDER_REVIEW)
        .reduce((s,a)=>s+(a.payment?.amount||0),0);

      const totalApps = APPLICATIONS_DATA.length || 1;
      const avg = Math.round(APPLICATIONS_DATA.reduce((s,a)=>s+(a.payment?.amount||0),0) / totalApps);

      const recentCount = Math.min(APPLICATIONS_DATA.length, 10);
      const proj = Math.round(avg * Math.max(5, recentCount) * 4);

      document.getElementById("rev-cleared").textContent = formatNGN(cleared);
      document.getElementById("rev-pending").textContent = formatNGN(pending);
      document.getElementById("rev-avg").textContent = formatNGN(avg);
      document.getElementById("rev-proj").textContent = formatNGN(proj);
    }

    // Verification
    function fillFromUrlCert(){
      const url=new URL(location.href);
      const cert=url.searchParams.get("cert");
      if(!cert) return;
      document.getElementById("verify-input").value=cert;
      verifyCertificate();
    }

    function verifyCertificate(){
      const input=(document.getElementById("verify-input").value||"").trim();
      const box=document.getElementById("verify-result");
      box.classList.remove("hidden");

      if(!input){
        box.innerHTML=`<div class="text-sm font-black text-red-600">Enter a certificate number or QR text.</div>`;
        return;
      }

      let certNo=input;
      try{
        if(input.startsWith("http")){
          const u=new URL(input);
          certNo=u.searchParams.get("cert") || input;
        }
      }catch{}

      const app = APPLICATIONS_DATA.find(a => a.certificate && a.certificate.certNo === certNo);

      if(!app){
        box.innerHTML = `
          <div class="font-black text-red-700">Not Verified</div>
          <div class="text-sm text-gray-600 mt-1">No approved certificate matched: <span class="font-mono font-black">${escapeHtml(certNo)}</span></div>
        `;
        return;
      }

      box.innerHTML = `
        <div class="font-black text-ng-green">Verified ✔</div>
        <div class="text-sm text-gray-600 mt-1">
          Certificate <span class="font-mono font-black">${escapeHtml(app.certificate.certNo)}</span> is valid.
        </div>
        <div class="text-sm text-gray-600 mt-2">
          <span class="font-black">Applicant:</span> ${escapeHtml(app.applicant)} •
          <span class="font-black">State:</span> ${escapeHtml(app.state)}
        </div>
      `;
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      loadData();
      document.getElementById("snapshot-date").textContent = new Date().toLocaleString();
      switchTab("dashboard");

      // If opened from cert link
      const url=new URL(location.href);
      const cert=url.searchParams.get("cert");
      if(cert){
        switchTab("verification");
        document.getElementById("verify-input").value=cert;
        verifyCertificate();
      }
    });
  </script>
</body>
</html>
