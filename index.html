<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Government of Nigeria - ARCON/DOAS Platform</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Load Leaflet CSS & JS (For Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Configure Tailwind for Nigerian Govt Theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ng-green': '#008751',     // Official Nigeria Green
                        'ng-green-dark': '#00643C',
                        'ng-green-light': '#E6F3ED',
                        'govt-gray': '#F3F4F6',
                        'govt-text': '#111827',
                        'gold': '#D4AF37',        // For premium/official accents
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                        serif: ['Merriweather', 'serif'], // For official headings
                    },
                }
            }
        }
    </script>

    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Globals Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'arcon-govt-platform';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db = null;
        let auth = null;
        let mapInstance = null;
        let markers = [];
        let revenueChartInstance = null;
        let complianceChartInstance = null;

        // --- Mock Data: Billboards (Verification) ---
        const mockBillboards = [
            { id: 'RV-LAG-001', title: 'Glo Unlimited Data', status: 'Approved', location: { state: 'Lagos', lga: 'Ikeja', lat: 6.6018, lng: 3.3515 }, expiry: '2026-11-01', type: 'LED Gantry', details: { agent: 'MediaReach OMD', sponsor: 'Globacom', fee: 1500000, paid: true } },
            { id: 'RV-FCT-042', title: 'Dangote Cement Promo', status: 'Pending', location: { state: 'Abuja FCT', lga: 'Municipal Area Council', lat: 9.0765, lng: 7.3986 }, expiry: '2025-05-15', type: 'Unipole', details: { agent: 'Insight Publicis', sponsor: 'Dangote Group', fee: 850000, paid: false } },
            { id: 'RV-RIV-089', title: 'Political Campaign 2027', status: 'Expired', location: { state: 'Rivers', lga: 'Port Harcourt', lat: 4.8156, lng: 7.0498 }, expiry: '2023-02-20', type: 'Billboard', details: { agent: 'Independent', sponsor: 'Party X', fee: 500000, paid: true } },
            { id: 'RV-KAD-112', title: 'Access Bank Loan', status: 'Approved', location: { state: 'Kaduna', lga: 'Kaduna North', lat: 10.5105, lng: 7.4165 }, expiry: '2026-08-10', type: 'Lamp Post', details: { agent: 'Algorithm Media', sponsor: 'Access Bank', fee: 200000, paid: true } },
            { id: 'RV-KNO-005', title: 'Indomie Noodles', status: 'Approved', location: { state: 'Kano', lga: 'Kano Municipal', lat: 12.0022, lng: 8.5920 }, expiry: '2026-01-30', type: 'Wall Drape', details: { agent: 'Starcom Media', sponsor: 'Dufil Prima', fee: 1200000, paid: true } },
        ];

        // --- Mock Data: Applications (New) ---
        const mockApplications = [
            { id: 'APP-2025-001', applicant: 'Zenith Bank PLC', type: 'Digital Billboard', state: 'Lagos', date: '2025-05-10', status: 'Pending', details: { lga: 'Victoria Island', duration: '12 Months', fee: 2500000 } },
            { id: 'APP-2025-002', applicant: 'MTN Nigeria', type: 'Street Lamp Post', state: 'Abuja FCT', date: '2025-05-11', status: 'Queried', details: { lga: 'Wuse II', duration: '6 Months', fee: 800000, queryReason: 'Incorrect dimensions provided' } },
            { id: 'APP-2025-003', applicant: 'Guinness Nigeria', type: 'Unipole', state: 'Lagos', date: '2025-05-09', status: 'Approved', details: { lga: 'Ikeja', duration: '24 Months', fee: 4000000 } }
        ];

        // --- Mock Data: Revenue (Financials) ---
        const mockRevenue = [
            { id: 'TRX-99821', date: '2025-05-01', agent: 'MediaReach OMD', amount: 4500000, type: 'Annual Renewal', status: 'Cleared' },
            { id: 'TRX-99822', date: '2025-05-02', agent: 'Insight Publicis', amount: 850000, type: 'New Application', status: 'Pending' },
            { id: 'TRX-99823', date: '2025-05-03', agent: 'Starcom Media', amount: 1200000, type: 'Penalty Fee', status: 'Cleared' },
            { id: 'TRX-99824', date: '2025-05-04', agent: 'Algorithm Media', amount: 200000, type: 'Verification Fee', status: 'Cleared' },
            { id: 'TRX-99825', date: '2025-05-04', agent: 'X3M Ideas', amount: 3500000, type: 'Digital License', status: 'Failed' },
        ];

        const NIGERIAN_STATES = ["Abia", "Adamawa", "Akwa Ibom", "Anambra", "Bauchi", "Bayelsa", "Benue", "Borno", "Cross River", "Delta", "Ebonyi", "Edo", "Ekiti", "Enugu", "Abuja FCT", "Gombe", "Imo", "Jigawa", "Kaduna", "Kano", "Katsina", "Kebbi", "Kogi", "Kwara", "Lagos", "Nasarawa", "Niger", "Ogun", "Ondo", "Osun", "Oyo", "Plateau", "Rivers", "Sokoto", "Taraba", "Yobe", "Zamfara"];

        
        // --- Initialization ---
        window.initializeFirebaseAndApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.BILLBOARD_DATA = mockBillboards;
                        window.REVENUE_DATA = mockRevenue;
                        window.APPLICATIONS_DATA = mockApplications;
                        
                        updateDashboardStats();
                        initCharts();
                        populateFilters();
                        renderRevenueTable(); 
                        renderApplicationsTable();
                        
                        window.switchTab('dashboard'); 
                    }
                });
            } catch (error) { console.error("Init Error:", error); }
        };

        // --- Navigation Logic ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-ng-green-dark', 'border-l-4', 'border-white');
                el.classList.add('text-gray-300', 'hover:bg-ng-green-dark');
            });

            document.getElementById(`${tabId}-view`).classList.remove('hidden');
            
            const navItem = document.getElementById(`nav-${tabId}`);
            if(navItem) {
                navItem.classList.remove('text-gray-300', 'hover:bg-ng-green-dark');
                navItem.classList.add('bg-ng-green-dark', 'text-white', 'border-l-4', 'border-white');
            }

            if (tabId === 'verification') {
                setTimeout(() => { window.filterAndRenderBillboards(); }, 100);
            }
        };

        // --- Dashboard Stats Logic ---
        function updateDashboardStats() {
            const totalRevenue = window.REVENUE_DATA.reduce((sum, item) => item.status === 'Cleared' ? sum + item.amount : sum, 0);
            const complianceRate = Math.round((window.BILLBOARD_DATA.filter(b => b.status === 'Approved').length / window.BILLBOARD_DATA.length) * 100);
            const pendingApps = window.APPLICATIONS_DATA.filter(b => b.status === 'Pending').length;

            document.getElementById('dash-revenue').innerText = `₦${(totalRevenue/1000000).toFixed(2)}M`;
            document.getElementById('dash-compliance').innerText = `${complianceRate}%`;
            document.getElementById('dash-pending').innerText = pendingApps;
            
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-GB', dateOptions);
        }

        // --- Charts Initialization ---
        function initCharts() {
            const ctxRev = document.getElementById('revenueChart').getContext('2d');
            if (revenueChartInstance) revenueChartInstance.destroy();
            revenueChartInstance = new Chart(ctxRev, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'IGR Collected (Millions ₦)',
                        data: [12.5, 19.2, 15.8, 22.1, 28.4, 18.0],
                        backgroundColor: '#008751',
                        borderRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxComp = document.getElementById('complianceChart').getContext('2d');
            if (complianceChartInstance) complianceChartInstance.destroy();
            complianceChartInstance = new Chart(ctxComp, {
                type: 'doughnut',
                data: {
                    labels: ['Compliant', 'Non-Compliant', 'Pending'],
                    datasets: [{
                        data: [65, 15, 20],
                        backgroundColor: ['#008751', '#DC2626', '#F59E0B'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
            });
        }

        // --- Verification/Map Logic ---
        window.filterAndRenderBillboards = () => {
            const listContainer = document.getElementById('billboard-list');
            const mapContainer = document.getElementById('map-view-container');
            const viewMode = document.getElementById('view-toggle').value;
            const filteredData = window.BILLBOARD_DATA;

            listContainer.innerHTML = '';

            if (viewMode === 'map') {
                listContainer.classList.add('hidden');
                mapContainer.classList.remove('hidden');
                
                if (!mapInstance) {
                    mapInstance = L.map('map').setView([9.0820, 8.6753], 6);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapInstance);
                }
                setTimeout(() => mapInstance.invalidateSize(), 100);
                
                markers.forEach(m => mapInstance.removeLayer(m));
                markers = [];
                filteredData.forEach(bb => {
                    if (bb.location.lat) {
                        const color = bb.status === 'Approved' ? 'green' : (bb.status === 'Pending' ? 'orange' : 'red');
                        const marker = L.circleMarker([bb.location.lat, bb.location.lng], {
                            radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8
                        }).addTo(mapInstance).bindPopup(`<b>${bb.title}</b><br>ID: ${bb.id}`);
                        marker.on('click', () => window.openDetailModal(bb));
                        markers.push(marker);
                    }
                });
            } else {
                mapContainer.classList.add('hidden');
                listContainer.classList.remove('hidden');
                listContainer.className = viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'flex flex-col space-y-3';
                
                filteredData.forEach(bb => {
                    const el = document.createElement('div');
                    const statusClass = bb.status === 'Approved' ? 'text-green-700 bg-green-50 border-green-200' : (bb.status === 'Pending' ? 'text-yellow-700 bg-yellow-50 border-yellow-200' : 'text-red-700 bg-red-50 border-red-200');
                    el.className = `p-4 rounded-lg border ${statusClass} cursor-pointer hover:shadow-md transition bg-white`;
                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-gray-900">${bb.title}</h4>
                                <p class="text-xs text-gray-500">${bb.id} | ${bb.location.state}</p>
                            </div>
                            <span class="px-2 py-1 text-xs font-bold uppercase rounded border ${statusClass}">${bb.status}</span>
                        </div>
                        <div class="mt-3 text-sm text-gray-600 grid grid-cols-2 gap-2">
                            <div><span class="text-xs text-gray-400 block">Agent</span>${bb.details.agent}</div>
                            <div><span class="text-xs text-gray-400 block">Type</span>${bb.type}</div>
                        </div>
                    `;
                    el.onclick = () => window.openDetailModal(bb);
                    listContainer.appendChild(el);
                });
            }
        };

        function populateFilters() {
            const select = document.getElementById('state-filter');
            // Check if select exists (it might be on a hidden tab)
            if(select) {
                select.innerHTML = '<option value="">All States</option>';
                NIGERIAN_STATES.sort().forEach(state => {
                    const opt = document.createElement('option');
                    opt.value = state;
                    opt.innerText = state;
                    select.appendChild(opt);
                });
            }
            // Populate Application Form State Select as well
             const applySelect = document.getElementById('apply-state');
             if(applySelect) {
                 NIGERIAN_STATES.sort().forEach(state => {
                    const opt = document.createElement('option');
                    opt.value = state;
                    opt.innerText = state;
                    applySelect.appendChild(opt);
                });
             }
        }
        
        function renderRevenueTable() {
            const revTable = document.getElementById('revenue-table-body');
            if (!revTable) return;
            revTable.innerHTML = ''; 

            if (!window.REVENUE_DATA || window.REVENUE_DATA.length === 0) {
                revTable.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No transactions found.</td></tr>';
                return;
            }

            window.REVENUE_DATA.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4 font-mono text-xs text-gray-500">${row.id}</td>
                    <td class="py-3 px-4">${row.agent}</td>
                    <td class="py-3 px-4">${row.type}</td>
                    <td class="py-3 px-4 font-semibold">₦${row.amount.toLocaleString()}</td>
                    <td class="py-3 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${row.status === 'Cleared' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${row.status}</span></td>
                    <td class="py-3 px-4 text-xs text-gray-500">${row.date}</td>
                `;
                revTable.appendChild(tr);
            });
        }

        // --- Application Management Logic ---
        function renderApplicationsTable() {
            const appTable = document.getElementById('applications-table-body');
            if (!appTable) return;
            appTable.innerHTML = '';

            window.APPLICATIONS_DATA.forEach(app => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                
                let statusColor = 'bg-yellow-100 text-yellow-800';
                if(app.status === 'Approved') statusColor = 'bg-green-100 text-green-800';
                if(app.status === 'Rejected') statusColor = 'bg-red-100 text-red-800';
                if(app.status === 'Queried') statusColor = 'bg-orange-100 text-orange-800';

                // Action Buttons
                let actions = `
                    <button onclick="manageApplication('${app.id}', 'view')" class="text-blue-600 hover:text-blue-800 mr-2 text-xs font-bold">VIEW</button>
                    ${app.status === 'Pending' ? `
                    <button onclick="manageApplication('${app.id}', 'approve')" class="text-green-600 hover:text-green-800 mr-2 text-xs font-bold">APPROVE</button>
                    <button onclick="manageApplication('${app.id}', 'query')" class="text-orange-600 hover:text-orange-800 mr-2 text-xs font-bold">QUERY</button>
                    ` : ''}
                    ${app.status === 'Approved' ? `
                    <button onclick="generateCertificate('${app.id}')" class="text-purple-600 hover:text-purple-800 text-xs font-bold flex items-center"><svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>CERT</button>
                    ` : ''}
                `;

                tr.innerHTML = `
                    <td class="py-3 px-4 font-mono text-xs text-gray-500">${app.id}</td>
                    <td class="py-3 px-4 font-semibold text-gray-800">${app.applicant}</td>
                    <td class="py-3 px-4">${app.type}</td>
                    <td class="py-3 px-4">${app.state}</td>
                    <td class="py-3 px-4"><span class="px-2 py-0.5 rounded-full text-xs ${statusColor}">${app.status}</span></td>
                    <td class="py-3 px-4 text-xs text-gray-500">${app.date}</td>
                    <td class="py-3 px-4 flex items-center">${actions}</td>
                `;
                appTable.appendChild(tr);
            });
        }

        window.manageApplication = (id, action) => {
            if(action === 'approve') {
                const app = window.APPLICATIONS_DATA.find(a => a.id === id);
                if(app) {
                    app.status = 'Approved';
                    // Conceptually move to billboards DB here
                    renderApplicationsTable();
                    alert(`Application ${id} Approved! You can now generate the certificate.`);
                    updateDashboardStats(); // Refresh pending count
                }
            } else if (action === 'query') {
                const reason = prompt("Enter query reason:");
                if(reason) {
                    const app = window.APPLICATIONS_DATA.find(a => a.id === id);
                    if(app) {
                        app.status = 'Queried';
                        app.details.queryReason = reason;
                        renderApplicationsTable();
                    }
                }
            } else if (action === 'view') {
                const app = window.APPLICATIONS_DATA.find(a => a.id === id);
                alert(`Details for ${app.applicant}:\nType: ${app.type}\nLocation: ${app.details.lga}, ${app.state}\nFee: ₦${app.details.fee.toLocaleString()}`);
            }
        };

        window.submitApplication = (e) => {
            e.preventDefault();
            const form = e.target;
            const newApp = {
                id: `APP-2025-${Math.floor(Math.random() * 900) + 100}`,
                applicant: form.applicant.value,
                type: form.type.value,
                state: form.state.value,
                date: new Date().toISOString().split('T')[0],
                status: 'Pending',
                details: {
                    lga: form.lga.value,
                    duration: '12 Months',
                    fee: 0 // To be assessed
                }
            };
            
            window.APPLICATIONS_DATA.unshift(newApp); // Add to top
            alert(`Application Submitted Successfully! Reference ID: ${newApp.id}`);
            form.reset();
            renderApplicationsTable(); // Update admin view
            updateDashboardStats();
            window.switchTab('app-management'); // Switch to admin view to see it
        };

        // --- Certificate Generation ---
        window.generateCertificate = (appId) => {
            const app = window.APPLICATIONS_DATA.find(a => a.id === appId);
            if(!app) return;

            const certModal = document.getElementById('certificate-modal');
            const certContent = document.getElementById('certificate-content');
            
            // Generate simple QR placeholder with ID
            const qrSvg = `
                <svg class="w-full h-full text-black" fill="currentColor" viewBox="0 0 24 24">
                     <path d="M3 3h6v6H3V3zm2 2v2h2V5H5zm8-2h6v6h-6V3zm2 2v2h2V5h-2zM3 11h6v6H3v-6zm2 2v2h2v-2H5zm13-2h3v3h-3v-3zm0 3h-3v3h3v-3zm3 3h-3v3h3v-3zm-6-3h3v3h-3v-3zm3 3h3v3h-3v-3zm-3-6h3v3h-3v-3z"/>
                     <rect x="8" y="8" width="2" height="2"/> <rect x="14" y="8" width="2" height="2"/> <rect x="8" y="14" width="2" height="2"/>
                </svg>
            `;

            certContent.innerHTML = `
                <div class="border-8 border-double border-ng-green p-8 bg-white relative">
                    <!-- Watermark -->
                    <div class="absolute inset-0 flex items-center justify-center opacity-5 pointer-events-none">
                        <svg class="w-96 h-96 text-ng-green" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>

                    <div class="text-center mb-8">
                        <div class="inline-block p-2 rounded-full mb-4">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/Coat_of_arms_of_Nigeria.svg" class="h-24 w-auto mx-auto" alt="Coat of Arms">
                        </div>
                        <h1 class="text-3xl font-serif font-bold text-ng-green mb-1">FEDERAL REPUBLIC OF NIGERIA</h1>
                        <h2 class="text-xl font-serif font-bold text-gray-800">ADVERTISING REGULATORY COUNCIL</h2>
                        <div class="h-1 w-32 bg-gold mx-auto my-4"></div>
                        <h3 class="text-4xl font-serif font-black text-ng-green-dark tracking-widest mt-6">CERTIFICATE OF LICENSE</h3>
                        <p class="text-sm font-mono text-gray-500 mt-2">LICENSE NO: ${app.id}</p>
                    </div>

                    <div class="text-center space-y-6 text-gray-800 font-serif text-lg leading-relaxed px-12">
                        <p>This is to certify that the advertising application submitted by:</p>
                        <p class="text-3xl font-bold border-b-2 border-gray-300 inline-block px-8 pb-1">${app.applicant}</p>
                        <p>has been duly vetted and approved for the following assets:</p>
                        <p class="font-bold text-xl">${app.type} in ${app.details.lga}, ${app.state}</p>
                        <p>in accordance with the Advertising Regulatory Council of Nigeria Act.</p>
                    </div>

                    <div class="mt-16 flex justify-between items-end">
                        <div class="text-center">
                            <div class="w-32 h-32 bg-white border border-gray-300 p-2 mx-auto mb-2">
                                ${qrSvg}
                            </div>
                            <p class="text-xs font-mono text-gray-500">Scan to Verify</p>
                        </div>
                        <div class="text-center">
                            <div class="w-48 border-b-2 border-gray-800 mb-2">
                                <span class="font-script text-2xl text-ng-green-dark">Dr. Olalekan Fadolapo</span>
                            </div>
                            <p class="font-bold text-sm uppercase">Director General, ARCON</p>
                            <p class="text-xs text-gray-500">${new Date().toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 text-center text-xs text-gray-400 font-mono">
                        This certificate is electronically generated and is valid without a physical seal.
                    </div>
                </div>
                
                <div class="mt-6 text-center no-print">
                    <button onclick="window.print()" class="bg-ng-green text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 flex items-center mx-auto">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                        Download / Print Certificate
                    </button>
                    <p class="text-sm text-gray-500 mt-2">Use browser print dialog to Save as PDF</p>
                </div>
            `;
            
            certModal.classList.remove('hidden');
        };

        // --- Common Modal Logic ---
        window.openDetailModal = (bb) => {
            const modal = document.getElementById('detail-modal');
            const content = document.getElementById('detail-content');
            // ... (Existing modal logic reuse) ...
            // Re-implementing briefly for completeness since code was replaced
             const feeFormatted = new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN' }).format(bb.details.fee);

            content.innerHTML = `
                <div class="flex justify-between items-center border-b pb-4 mb-4">
                    <div class="flex items-center space-x-3">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/b/bc/Coat_of_arms_of_Nigeria.svg" class="h-12 w-auto" alt="Coat of Arms">
                        <div>
                            <h3 class="text-lg font-bold text-ng-green uppercase">Verification Certificate</h3>
                            <p class="text-xs text-gray-500">Federal Republic of Nigeria</p>
                        </div>
                    </div>
                    <div class="text-right">
                         <span class="block text-sm font-mono text-gray-400">ID: ${bb.id}</span>
                         <span class="inline-block px-3 py-1 rounded text-xs font-bold text-white ${bb.status === 'Approved' ? 'bg-ng-green' : 'bg-red-500'}">${bb.status.toUpperCase()}</span>
                    </div>
                </div>
                <!-- Details -->
                 <div class="grid grid-cols-2 gap-6 text-sm">
                    <div><p class="text-xs text-gray-400 uppercase">Board Title</p><p class="font-semibold text-gray-800">${bb.title}</p></div>
                    <div><p class="text-xs text-gray-400 uppercase">Location</p><p class="font-semibold text-gray-800">${bb.location.lga}, ${bb.location.state}</p></div>
                    <div><p class="text-xs text-gray-400 uppercase">Agent</p><p class="font-semibold text-gray-800">${bb.details.agent}</p></div>
                    <div><p class="text-xs text-gray-400 uppercase">Fee</p><p class="font-semibold text-gray-800">${feeFormatted}</p></div>
                </div>
            `;
            modal.classList.remove('hidden');
        };

        document.addEventListener('DOMContentLoaded', () => {
            window.initializeFirebaseAndApp();
        });

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@400;700&family=Great+Vibes&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #F3F4F6; }
        h1, h2, h3 { font-family: 'Merriweather', serif; }
        .font-script { font-family: 'Great Vibes', cursive; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background-color: transparent; }
        
        .nav-item { transition: all 0.2s ease-in-out; }

        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            #certificate-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: white; }
            #app, aside, header { display: none; }
        }
    </style>
</head>
<body class="text-govt-text h-screen overflow-hidden flex">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-ng-green text-white flex flex-col shadow-2xl z-20 no-print">
        <!-- Brand -->
        <div class="p-6 border-b border-green-600 flex items-center space-x-3 bg-ng-green-dark">
            <div class="bg-white p-1 rounded-full">
                <svg class="w-8 h-8 text-ng-green" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-widest uppercase">ARCON</h1>
                <p class="text-[10px] text-green-200 uppercase">Federal Govt of Nigeria</p>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-grow py-6 space-y-1">
            <a href="#" id="nav-dashboard" onclick="window.switchTab('dashboard')" class="nav-item flex items-center px-6 py-3 text-sm font-medium border-l-4 border-white bg-ng-green-dark">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                Executive Dashboard
            </a>
            
            <div class="px-6 py-2 text-xs font-bold text-green-200 uppercase mt-4">Public Services</div>
            <a href="#" id="nav-apply" onclick="window.switchTab('apply')" class="nav-item flex items-center px-6 py-3 text-sm font-medium text-green-100 hover:bg-ng-green-dark border-l-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.586a2 2 0 012.828 0L20 7.172v.25M15 13.5v-1.5m-3 3v-1.5m-3 3v-1.5" /></svg>
                License Application
            </a>

            <div class="px-6 py-2 text-xs font-bold text-green-200 uppercase mt-4">Regulatory Admin</div>
            <a href="#" id="nav-app-management" onclick="window.switchTab('app-management')" class="nav-item flex items-center px-6 py-3 text-sm font-medium text-green-100 hover:bg-ng-green-dark border-l-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                Application Mgmt
            </a>
            <a href="#" id="nav-verification" onclick="window.switchTab('verification')" class="nav-item flex items-center px-6 py-3 text-sm font-medium text-green-100 hover:bg-ng-green-dark border-l-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0121 18.382V7.618a1 1 0 01-.553-.894L15 4m0 13V4m0 0L9 7" /></svg>
                Verification Portal
            </a>
            <a href="#" id="nav-revenue" onclick="window.switchTab('revenue')" class="nav-item flex items-center px-6 py-3 text-sm font-medium text-green-100 hover:bg-ng-green-dark border-l-4 border-transparent">
                <svg class="w-5 h-5 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Revenue / IGR
            </a>
        </nav>

        <!-- User Profile -->
        <div class="p-6 border-t border-green-600 bg-ng-green-dark">
            <div class="flex items-center">
                <div class="w-8 h-8 rounded-full bg-white text-ng-green font-bold flex items-center justify-center">DG</div>
                <div class="ml-3">
                    <p class="text-xs font-semibold">Director General</p>
                    <p class="text-[10px] text-green-300">Admin Access</p>
                </div>
            </div>
        </div>
    </aside>


    <!-- MAIN CONTENT -->
    <main class="flex-grow flex flex-col h-screen overflow-hidden bg-gray-50">
        
        <!-- TOP HEADER -->
        <header class="bg-white shadow-sm border-b px-8 py-4 flex justify-between items-center z-10 no-print">
            <div>
                <h2 class="text-2xl font-bold text-gray-800 font-serif">Advertising Regulatory Council of Nigeria</h2>
                <p class="text-sm text-gray-500">Integrated Regulatory Management System (IRMS)</p>
            </div>
            <div class="text-right">
                <p id="current-date" class="text-sm font-semibold text-ng-green"></p>
                <div class="flex items-center space-x-2 justify-end mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-xs text-gray-400">System Operational</span>
                </div>
            </div>
        </header>

        <!-- SCROLLABLE CONTENT AREA -->
        <div class="flex-grow overflow-y-auto p-8 relative">

            <!-- VIEW 1: EXECUTIVE DASHBOARD -->
            <section id="dashboard-view" class="view-section space-y-8">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Revenue KPI -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">YTD Revenue (IGR)</p>
                                <h3 id="dash-revenue" class="text-3xl font-bold text-gray-900 mt-2">₦0.00M</h3>
                                <p class="text-xs text-green-600 mt-1 flex items-center">+12.5% vs Last Year</p>
                            </div>
                            <div class="p-3 bg-green-50 rounded-full text-ng-green">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                        </div>
                    </div>
                     <!-- Compliance KPI -->
                     <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">National Compliance Index</p>
                                <h3 id="dash-compliance" class="text-3xl font-bold text-gray-900 mt-2">0%</h3>
                                <p class="text-xs text-red-500 mt-1">Requires Enforcement in 4 States</p>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-full text-blue-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                        </div>
                    </div>
                    <!-- Pending KPI -->
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-wide">Pending Applications</p>
                                <h3 id="dash-pending" class="text-3xl font-bold text-gray-900 mt-2">0</h3>
                                <p class="text-xs text-gray-500 mt-1">Average processing time: 4 Days</p>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-full text-yellow-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <h4 class="text-sm font-bold text-gray-700 mb-4 border-b pb-2">Revenue Collection Trends (6 Months)</h4>
                        <div class="h-64"><canvas id="revenueChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-100">
                        <h4 class="text-sm font-bold text-gray-700 mb-4 border-b pb-2">Compliance Distribution</h4>
                        <div class="h-64 flex items-center justify-center"><canvas id="complianceChart"></canvas></div>
                    </div>
                </div>
            </section>

            <!-- VIEW: NEW APPLICATION (PUBLIC) -->
            <section id="apply-view" class="view-section hidden max-w-4xl mx-auto">
                <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden">
                    <div class="bg-ng-green p-6 text-white">
                        <h3 class="text-xl font-serif font-bold">New Advertisement License Application</h3>
                        <p class="text-green-100 text-sm">Fill out the details below to register a new advertising asset.</p>
                    </div>
                    <form onsubmit="window.submitApplication(event)" class="p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Applicant / Company Name</label>
                                <input type="text" name="applicant" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Advertisement Type</label>
                                <select name="type" class="w-full p-2 border border-gray-300 rounded bg-white">
                                    <option>Digital Billboard</option>
                                    <option>Static Billboard</option>
                                    <option>Lamp Post</option>
                                    <option>Gantry</option>
                                    <option>Wall Drape</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Structure Size (e.g. 12m x 9m)</label>
                                <input type="text" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                <select name="state" id="apply-state" class="w-full p-2 border border-gray-300 rounded bg-white">
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Local Government Area (LGA)</label>
                                <input type="text" name="lga" required class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-green-500 outline-none">
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Visual Concept / Artwork</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50">
                                <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                <p class="text-sm text-gray-500">Drag and drop file here, or <span class="text-blue-600 cursor-pointer hover:underline">browse</span></p>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit" class="bg-ng-green text-white px-8 py-3 rounded font-bold shadow hover:bg-green-700 transition">Submit Application</button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- VIEW: APPLICATION MANAGEMENT (ADMIN) -->
            <section id="app-management-view" class="view-section hidden space-y-6">
                 <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 font-serif">Application Management</h3>
                    <div class="flex space-x-2">
                        <button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50">Filter: All</button>
                        <button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50">Export List</button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-semibold border-b">
                            <tr>
                                <th class="py-3 px-4">App ID</th>
                                <th class="py-3 px-4">Applicant</th>
                                <th class="py-3 px-4">Type</th>
                                <th class="py-3 px-4">State</th>
                                <th class="py-3 px-4">Status</th>
                                <th class="py-3 px-4">Date</th>
                                <th class="py-3 px-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="applications-table-body" class="text-sm text-gray-700">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- VIEW: VERIFICATION PORTAL -->
            <section id="verification-view" class="view-section hidden space-y-6">
                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-wrap gap-4 items-end">
                    <div class="flex-grow">
                        <label class="text-xs font-semibold text-gray-500">Search Assets</label>
                        <input type="text" id="search-input" placeholder="Enter ID, Agent, or Sponsor..." class="w-full mt-1 p-2 border rounded text-sm focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div class="w-48">
                        <label class="text-xs font-semibold text-gray-500">Jurisdiction (State)</label>
                        <select id="state-filter" class="w-full mt-1 p-2 border rounded text-sm bg-white" onchange="window.filterAndRenderBillboards()"><option value="">All States</option></select>
                    </div>
                    <div class="w-48">
                        <label class="text-xs font-semibold text-gray-500">Display Mode</label>
                        <select id="view-toggle" class="w-full mt-1 p-2 border rounded text-sm bg-white" onchange="window.filterAndRenderBillboards()">
                            <option value="map">Geospatial Map</option>
                            <option value="list">Asset List</option>
                            <option value="grid">Grid View</option>
                        </select>
                    </div>
                </div>
                <div id="map-view-container" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden relative h-[600px]">
                    <div id="map" class="w-full h-full z-[1]"></div>
                </div>
                <div id="billboard-list" class="hidden"></div>
            </section>

            <!-- VIEW: REVENUE / IGR -->
            <section id="revenue-view" class="view-section hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-gray-800 font-serif">Financial Transaction Logs</h3>
                    <button class="text-sm text-ng-green font-medium hover:underline">Export to CSV</button>
                </div>
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-xs uppercase text-gray-500 font-semibold border-b">
                            <tr>
                                <th class="py-3 px-4">Transaction ID</th>
                                <th class="py-3 px-4">Paying Agent</th>
                                <th class="py-3 px-4">Payment Type</th>
                                <th class="py-3 px-4">Amount</th>
                                <th class="py-3 px-4">Status</th>
                                <th class="py-3 px-4">Date</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-table-body" class="text-sm text-gray-700"></tbody>
                    </table>
                </div>
            </section>

        </div>
    </main>

    <!-- Modal for Detailed View (Verification) -->
    <div id="detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 p-4 no-print">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg overflow-hidden relative">
            <button onclick="document.getElementById('detail-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="detail-content" class="p-8"></div>
        </div>
    </div>

    <!-- Modal for Certificate (Printable) -->
    <div id="certificate-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-75 p-4 overflow-y-auto">
        <div class="bg-white shadow-2xl w-full max-w-3xl relative animate-[fadeIn_0.3s_ease-out]">
            <button onclick="document.getElementById('certificate-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 no-print z-50">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="certificate-content"></div>
        </div>
    </div>

</body>
</html>
